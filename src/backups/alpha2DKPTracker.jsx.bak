import React, { useState, useEffect, useMemo } from 'react';
import { useSupabaseState } from './useSupabaseState';
import { supabase } from "./supabaseClient";


// ============================================================================
// THE SUNKEN DKP SYSTEM - Guild Loot Tracker for WoW Classic TBC
// ============================================================================

// ============================================================================
// DATA CONSTANTS
// ============================================================================

const TBC_RAIDS = {
  karazhan: { name: "Karazhan", shortName: "Kara", bosses: ["Attumen the Huntsman", "Moroes", "Maiden of Virtue", "Opera Event", "The Curator", "Shade of Aran", "Terestian Illhoof", "Netherspite", "Chess Event", "Prince Malchezaar", "Nightbane"] },
  gruul: { name: "Gruul's Lair", shortName: "Gruul", bosses: ["High King Maulgar", "Gruul the Dragonkiller"] },
  magtheridon: { name: "Magtheridon's Lair", shortName: "Mag", bosses: ["Magtheridon"] },
  ssc: { name: "Serpentshrine Cavern", shortName: "SSC", bosses: ["Hydross the Unstable", "The Lurker Below", "Leotheras the Blind", "Fathom-Lord Karathress", "Morogrim Tidewalker", "Lady Vashj"] },
  tk: { name: "Tempest Keep: The Eye", shortName: "TK", bosses: ["Al'ar", "Void Reaver", "High Astromancer Solarian", "Kael'thas Sunstrider"] },
  hyjal: { name: "Battle for Mount Hyjal", shortName: "Hyjal", bosses: ["Rage Winterchill", "Anetheron", "Kaz'rogal", "Azgalor", "Archimonde"] },
  bt: { name: "Black Temple", shortName: "BT", bosses: ["High Warlord Naj'entus", "Supremus", "Shade of Akama", "Teron Gorefiend", "Gurtogg Bloodboil", "Reliquary of Souls", "Mother Shahraz", "Illidari Council", "Illidan Stormrage"] },
  sunwell: { name: "Sunwell Plateau", shortName: "SWP", bosses: ["Kalecgos", "Brutallus", "Felmyst", "Eredar Twins", "M'uru", "Kil'jaeden"] },
  za: { name: "Zul'Aman", shortName: "ZA", bosses: ["Nalorakk", "Akil'zon", "Jan'alai", "Halazzi", "Hex Lord Malacrass", "Zul'jin"] }
};

// TBC Raid Loot Tables - Wowhead Item IDs for tooltip integration
// Format: { id: wowheadItemId, name: "Item Name", cat: "category" }
const RAID_LOOT = {
  karazhan: [
    // Attumen the Huntsman
    { id: 28477, name: "Harbinger Bands", cat: "tierArmor" },
    { id: 28454, name: "Stalker's War Bands", cat: "tierArmor" },
    { id: 28453, name: "Bracers of the White Stag", cat: "tierArmor" },
    { id: 28502, name: "Vambraces of Courage", cat: "tierArmor" },
    { id: 28503, name: "Whirlwind Bracers", cat: "tierArmor" },
    { id: 28505, name: "Gauntlets of Renewed Hope", cat: "tierArmor" },
    { id: 28506, name: "Gloves of Dexterous Manipulation", cat: "tierArmor" },
    { id: 28504, name: "Steelhawk Crossbow", cat: "weapons" },
    { id: 28507, name: "Handwraps of Flowing Thought", cat: "tierArmor" },
    { id: 28508, name: "Gloves of Saintly Blessings", cat: "tierArmor" },
    { id: 28509, name: "Worgen Claw Necklace", cat: "ringsNeck" },
    { id: 30480, name: "Fiery Warhorse's Reins", cat: "bags" },
    // Moroes
    { id: 28529, name: "Royal Cloak of Arathi Kings", cat: "tierArmor" },
    { id: 28570, name: "Shadow-Cloak of Dalaran", cat: "tierArmor" },
    { id: 28565, name: "Nethershard Girdle", cat: "tierArmor" },
    { id: 28545, name: "Edgewalker Longboots", cat: "tierArmor" },
    { id: 28567, name: "Belt of Gale Force", cat: "tierArmor" },
    { id: 28566, name: "Crimson Girdle of the Indomitable", cat: "tierArmor" },
    { id: 28569, name: "Boots of Valiance", cat: "tierArmor" },
    { id: 28530, name: "Brooch of Unquenchable Fury", cat: "ringsNeck" },
    { id: 28528, name: "Moroes' Lucky Pocket Watch", cat: "trinkets" },
    { id: 28525, name: "Signed and Sealed", cat: "offhand" },
    { id: 28524, name: "Emerald Ripper", cat: "weapons" },
    // Maiden of Virtue
    { id: 28511, name: "Mitts of the Treemender", cat: "tierArmor" },
    { id: 28510, name: "Bands of Nefarious Deeds", cat: "tierArmor" },
    { id: 28515, name: "Bands of Indwelling", cat: "tierArmor" },
    { id: 28512, name: "Bracers of Maliciousness", cat: "tierArmor" },
    { id: 28514, name: "Bracers of Justice", cat: "tierArmor" },
    { id: 28516, name: "Barbed Choker of Discipline", cat: "ringsNeck" },
    { id: 28517, name: "Boots of Foretelling", cat: "tierArmor" },
    { id: 28520, name: "Shard of the Virtuous", cat: "weapons" },
    { id: 28522, name: "Luminous Pearls of Insight", cat: "ringsNeck" },
    { id: 28521, name: "Totem of Healing Rains", cat: "relics" },
    // Opera Event
    { id: 28578, name: "Beastmaw Pauldrons", cat: "tierArmor" },
    { id: 28583, name: "Big Bad Wolf's Head", cat: "tierArmor" },
    { id: 28582, name: "Red Riding Hood's Cloak", cat: "tierArmor" },
    { id: 28579, name: "Wolfslayer Sniper Rifle", cat: "weapons" },
    { id: 28581, name: "Ribbon of Sacrifice", cat: "trinkets" },
    { id: 28572, name: "Blade of the Unrequited", cat: "weapons" },
    { id: 28573, name: "Despair", cat: "weapons" },
    { id: 28587, name: "Legacy", cat: "weapons" },
    { id: 28586, name: "Romulo's Poison Vial", cat: "trinkets" },
    { id: 28590, name: "Masquerade Gown", cat: "tierArmor" },
    { id: 28594, name: "Trial-Fire Trousers", cat: "tierArmor" },
    { id: 28589, name: "Beastmaw Pauldrons", cat: "tierArmor" },
    { id: 28593, name: "Eternium Greathelm", cat: "tierArmor" },
    { id: 28591, name: "Earthsoul Leggings", cat: "tierArmor" },
    { id: 28592, name: "Libram of Souls Redeemed", cat: "relics" },
    // The Curator
    { id: 28612, name: "Pauldrons of the Solace-Giver", cat: "tierArmor" },
    { id: 28647, name: "Forest Wind Shoulderpads", cat: "tierArmor" },
    { id: 28631, name: "Dragon-Quake Shoulderguards", cat: "tierArmor" },
    { id: 28621, name: "Wrynn Dynasty Greaves", cat: "tierArmor" },
    { id: 28649, name: "Garona's Signet Ring", cat: "ringsNeck" },
    { id: 28633, name: "Staff of Infinite Mysteries", cat: "weapons" },
    { id: 29757, name: "Gloves of the Fallen Champion", cat: "tierArmor" },
    { id: 29758, name: "Gloves of the Fallen Defender", cat: "tierArmor" },
    { id: 29756, name: "Gloves of the Fallen Hero", cat: "tierArmor" },
    // Shade of Aran
    { id: 28672, name: "Drape of the Dark Reavers", cat: "tierArmor" },
    { id: 28726, name: "Mantle of the Mind Flayer", cat: "tierArmor" },
    { id: 28666, name: "Pauldrons of the Justice-Seeker", cat: "tierArmor" },
    { id: 28670, name: "Boots of the Infernal Coven", cat: "tierArmor" },
    { id: 28663, name: "Boots of the Incorrupt", cat: "tierArmor" },
    { id: 28669, name: "Rapscallion Boots", cat: "tierArmor" },
    { id: 28671, name: "Steelspine Faceguard", cat: "tierArmor" },
    { id: 28674, name: "Saberclaw Talisman", cat: "ringsNeck" },
    { id: 28675, name: "Shermanar Great-Ring", cat: "ringsNeck" },
    { id: 28727, name: "Pendant of the Violet Eye", cat: "ringsNeck" },
    { id: 28673, name: "Tirisfal Wand of Ascendancy", cat: "weapons" },
    { id: 28728, name: "Aran's Soothing Sapphire", cat: "offhand" },
    // Terestian Illhoof
    { id: 28660, name: "Gilded Thorium Cloak", cat: "tierArmor" },
    { id: 28653, name: "Shadowvine Cloak of Infusion", cat: "tierArmor" },
    { id: 28652, name: "Cincture of Will", cat: "tierArmor" },
    { id: 28654, name: "Malefic Girdle", cat: "tierArmor" },
    { id: 28655, name: "Cord of Nature's Sustenance", cat: "tierArmor" },
    { id: 28656, name: "Girdle of the Prowler", cat: "tierArmor" },
    { id: 28657, name: "Fool's Bane", cat: "weapons" },
    { id: 28658, name: "Terestian's Stranglestaff", cat: "weapons" },
    { id: 28659, name: "Xavian Stiletto", cat: "weapons" },
    { id: 28661, name: "Mender's Heart-Ring", cat: "ringsNeck" },
    { id: 28662, name: "Breastplate of the Lightbinder", cat: "tierArmor" },
    // Netherspite
    { id: 28744, name: "Uni-Mind Headdress", cat: "tierArmor" },
    { id: 28742, name: "Pantaloons of Repentance", cat: "tierArmor" },
    { id: 28735, name: "Earthblood Chestguard", cat: "tierArmor" },
    { id: 28740, name: "Rip-Flayer Leggings", cat: "tierArmor" },
    { id: 28743, name: "Mantle of Abrahmis", cat: "tierArmor" },
    { id: 28733, name: "Girdle of Truth", cat: "tierArmor" },
    { id: 28732, name: "Cowl of Defiance", cat: "tierArmor" },
    { id: 28741, name: "Skulker's Greaves", cat: "tierArmor" },
    { id: 28734, name: "Jewel of Infinite Possibilities", cat: "ringsNeck" },
    { id: 28731, name: "Shining Chain of the Afterworld", cat: "ringsNeck" },
    { id: 28730, name: "Mithril Band of the Unscarred", cat: "ringsNeck" },
    { id: 28729, name: "Spiteblade", cat: "weapons" },
    // Chess Event
    { id: 28756, name: "Headdress of the High Potentate", cat: "tierArmor" },
    { id: 28755, name: "Bladed Shoulderpads of the Merciless", cat: "tierArmor" },
    { id: 28750, name: "Girdle of Treachery", cat: "tierArmor" },
    { id: 28752, name: "Forestlord Striders", cat: "tierArmor" },
    { id: 28751, name: "Heart-Flame Leggings", cat: "tierArmor" },
    { id: 28746, name: "Fiend Slayer Boots", cat: "tierArmor" },
    { id: 28748, name: "Legplates of the Innocent", cat: "tierArmor" },
    { id: 28747, name: "Battlescar Boots", cat: "tierArmor" },
    { id: 28749, name: "King's Defender", cat: "weapons" },
    { id: 28745, name: "Mithril Chain of Heroism", cat: "ringsNeck" },
    { id: 28753, name: "Ring of Recurrence", cat: "ringsNeck" },
    { id: 28754, name: "Triptych Shield of the Ancients", cat: "offhand" },
    // Prince Malchezaar
    { id: 28765, name: "Stainless Cloak of the Pure Hearted", cat: "tierArmor" },
    { id: 28766, name: "Ruby Drape of the Mysticant", cat: "tierArmor" },
    { id: 28764, name: "Farstrider Wildercloak", cat: "tierArmor" },
    { id: 28762, name: "Adornment of Stolen Souls", cat: "ringsNeck" },
    { id: 28763, name: "Jade Ring of the Everliving", cat: "ringsNeck" },
    { id: 28757, name: "Ring of a Thousand Marks", cat: "ringsNeck" },
    { id: 28770, name: "Nathrezim Mindblade", cat: "weapons" },
    { id: 28768, name: "Malchazeen", cat: "weapons" },
    { id: 28767, name: "The Decapitator", cat: "weapons" },
    { id: 28773, name: "Gorehowl", cat: "weapons" },
    { id: 28771, name: "Light's Justice", cat: "weapons" },
    { id: 28772, name: "Sunfury Bow of the Phoenix", cat: "weapons" },
    { id: 29760, name: "Helm of the Fallen Champion", cat: "tierArmor" },
    { id: 29761, name: "Helm of the Fallen Defender", cat: "tierArmor" },
    { id: 29759, name: "Helm of the Fallen Hero", cat: "tierArmor" },
    // Nightbane
    { id: 28602, name: "Robe of the Elder Scribes", cat: "tierArmor" },
    { id: 28601, name: "Chestguard of the Conniver", cat: "tierArmor" },
    { id: 28600, name: "Stonebough Jerkin", cat: "tierArmor" },
    { id: 28599, name: "Scaled Breastplate of Carnage", cat: "tierArmor" },
    { id: 28597, name: "Panzar'Thar Breastplate", cat: "tierArmor" },
    { id: 28608, name: "Ironstriders of Urgency", cat: "tierArmor" },
    { id: 28610, name: "Ferocious Swift-Kickers", cat: "tierArmor" },
    { id: 28609, name: "Emberspur Talisman", cat: "ringsNeck" },
    { id: 28603, name: "Talisman of Nightbane", cat: "ringsNeck" },
    { id: 28604, name: "Nightstaff of the Everliving", cat: "weapons" },
    { id: 28611, name: "Dragonheart Flameshield", cat: "offhand" },
    { id: 28606, name: "Shield of Impenetrable Darkness", cat: "offhand" },
  ],
  gruul: [
    // High King Maulgar
    { id: 28797, name: "Brute Cloak of the Ogre-Magi", cat: "tierArmor" },
    { id: 28799, name: "Belt of Divine Inspiration", cat: "tierArmor" },
    { id: 28796, name: "Malefic Mask of the Shadows", cat: "tierArmor" },
    { id: 28801, name: "Maulgar's Warhelm", cat: "tierArmor" },
    { id: 28795, name: "Bladespire Warbands", cat: "tierArmor" },
    { id: 28800, name: "Hammer of the Naaru", cat: "weapons" },
    { id: 29763, name: "Pauldrons of the Fallen Champion", cat: "tierArmor" },
    { id: 29764, name: "Pauldrons of the Fallen Defender", cat: "tierArmor" },
    { id: 29762, name: "Pauldrons of the Fallen Hero", cat: "tierArmor" },
    // Gruul the Dragonkiller
    { id: 28804, name: "Collar of Cho'gall", cat: "ringsNeck" },
    { id: 28803, name: "Cowl of Nature's Breath", cat: "tierArmor" },
    { id: 28828, name: "Gronn-Stitched Girdle", cat: "tierArmor" },
    { id: 28827, name: "Gauntlets of the Dragonslayer", cat: "tierArmor" },
    { id: 28810, name: "Windshear Boots", cat: "tierArmor" },
    { id: 28824, name: "Gauntlets of Martial Perfection", cat: "tierArmor" },
    { id: 28822, name: "Teeth of Gruul", cat: "ringsNeck" },
    { id: 28823, name: "Eye of Gruul", cat: "trinkets" },
    { id: 28830, name: "Dragonspine Trophy", cat: "trinkets" },
    { id: 28794, name: "Axe of the Gronn Lords", cat: "weapons" },
    { id: 28825, name: "Aldori Legacy Defender", cat: "offhand" },
    { id: 28826, name: "Shuriken of Negation", cat: "weapons" },
    { id: 29766, name: "Leggings of the Fallen Champion", cat: "tierArmor" },
    { id: 29767, name: "Leggings of the Fallen Defender", cat: "tierArmor" },
    { id: 29765, name: "Leggings of the Fallen Hero", cat: "tierArmor" },
  ],
  magtheridon: [
    { id: 28777, name: "Cloak of the Pit Stalker", cat: "tierArmor" },
    { id: 28780, name: "Soul-Eater's Handwraps", cat: "tierArmor" },
    { id: 28776, name: "Liar's Tongue Gloves", cat: "tierArmor" },
    { id: 28778, name: "Terror Pit Girdle", cat: "tierArmor" },
    { id: 28775, name: "Thundering Greathelm", cat: "tierArmor" },
    { id: 28779, name: "Girdle of the Endless Pit", cat: "tierArmor" },
    { id: 28789, name: "Eye of Magtheridon", cat: "trinkets" },
    { id: 28781, name: "Karaborian Talisman", cat: "ringsNeck" },
    { id: 28782, name: "Crystalheart Pulse-Staff", cat: "weapons" },
    { id: 28783, name: "Eredar Wand of Obliteration", cat: "weapons" },
    { id: 28774, name: "Glaive of the Pit", cat: "weapons" },
    { id: 29458, name: "Aegis of the Vindicator", cat: "offhand" },
    { id: 32385, name: "Magtheridon's Head", cat: "bags" },
    { id: 29754, name: "Chestguard of the Fallen Champion", cat: "tierArmor" },
    { id: 29753, name: "Chestguard of the Fallen Defender", cat: "tierArmor" },
    { id: 29755, name: "Chestguard of the Fallen Hero", cat: "tierArmor" },
  ],
  ssc: [
    // Hydross the Unstable
    { id: 30056, name: "Shoulderpads of the Stranger", cat: "tierArmor" },
    { id: 30054, name: "Ranger-General's Chestguard", cat: "tierArmor" },
    { id: 30055, name: "Scarab of Displacement", cat: "trinkets" },
    { id: 30050, name: "Boots of the Shifting Nightmare", cat: "tierArmor" },
    { id: 30047, name: "Blackfathom Warbands", cat: "tierArmor" },
    { id: 30053, name: "Pauldrons of the Wardancer", cat: "tierArmor" },
    { id: 30048, name: "Brighthelm of Justice", cat: "tierArmor" },
    { id: 30052, name: "Ring of Lethality", cat: "ringsNeck" },
    { id: 30051, name: "Idol of the Crescent Goddess", cat: "relics" },
    { id: 30049, name: "Fathom-Brooch of the Tidewalker", cat: "ringsNeck" },
    { id: 33055, name: "Bands of the Depths", cat: "tierArmor" },
    // The Lurker Below
    { id: 30059, name: "Earring of Soulful Meditation", cat: "ringsNeck" },
    { id: 30065, name: "Glowing Breastplate of Truth", cat: "tierArmor" },
    { id: 30064, name: "Cord of Screaming Terrors", cat: "tierArmor" },
    { id: 30062, name: "Grove-Bands of Remulos", cat: "tierArmor" },
    { id: 30060, name: "Ancestral Ring of Conquest", cat: "ringsNeck" },
    { id: 30061, name: "Lurker's Grasp", cat: "ringsNeck" },
    { id: 30063, name: "Velvet Boots of the Guardian", cat: "tierArmor" },
    { id: 30058, name: "Mallet of the Tides", cat: "weapons" },
    { id: 30066, name: "Choker of Animalistic Fury", cat: "ringsNeck" },
    { id: 30057, name: "Bracers of Eradication", cat: "tierArmor" },
    { id: 30067, name: "Velvet Boots of the Guardian", cat: "tierArmor" },
    // Leotheras the Blind
    { id: 30092, name: "Orca-Hide Boots", cat: "tierArmor" },
    { id: 30097, name: "Coral-Barbed Shoulderpads", cat: "tierArmor" },
    { id: 30091, name: "True-Aim Stalker Bands", cat: "tierArmor" },
    { id: 30096, name: "Girdle of the Invulnerable", cat: "tierArmor" },
    { id: 30098, name: "Fang of the Leviathan", cat: "weapons" },
    { id: 30095, name: "Fang of Vashj", cat: "weapons" },
    { id: 30090, name: "World Breaker", cat: "weapons" },
    { id: 30094, name: "Gloves of the Vanquished Champion", cat: "tierArmor" },
    { id: 30093, name: "Gloves of the Vanquished Defender", cat: "tierArmor" },
    { id: 30091, name: "Gloves of the Vanquished Hero", cat: "tierArmor" },
    // Fathom-Lord Karathress
    { id: 30100, name: "Soul-Strider Boots", cat: "tierArmor" },
    { id: 30101, name: "Bloodsea Brigand's Vest", cat: "tierArmor" },
    { id: 30099, name: "Frayed Tether of the Drowned", cat: "ringsNeck" },
    { id: 30663, name: "Fathom-Lord's Leggings", cat: "tierArmor" },
    { id: 30626, name: "Sextant of Unstable Currents", cat: "trinkets" },
    { id: 30627, name: "Tsunami Talisman", cat: "trinkets" },
    { id: 30620, name: "Spyglass of the Hidden Fleet", cat: "trinkets" },
    { id: 30621, name: "Prism of Inner Calm", cat: "trinkets" },
    { id: 30008, name: "Boots of Courage Unending", cat: "tierArmor" },
    { id: 30007, name: "Belt of One-Hundred Deaths", cat: "tierArmor" },
    // Morogrim Tidewalker
    { id: 30098, name: "Razor-Scale Battlecloak", cat: "tierArmor" },
    { id: 30100, name: "Serpent-Coil Braid", cat: "ringsNeck" },
    { id: 30099, name: "Luminescent Rod of the Naaru", cat: "weapons" },
    { id: 30720, name: "Serpent Spine Longbow", cat: "weapons" },
    { id: 30082, name: "Talon of Azshara", cat: "weapons" },
    { id: 30084, name: "Pauldrons of the Argent Sentinel", cat: "tierArmor" },
    { id: 30081, name: "Faceguard of the Endless Watch", cat: "tierArmor" },
    { id: 30085, name: "Mantle of the Tireless Tracker", cat: "tierArmor" },
    { id: 30080, name: "Warboots of Obliteration", cat: "tierArmor" },
    { id: 30083, name: "Ring of Sundered Souls", cat: "ringsNeck" },
    // Lady Vashj
    { id: 30107, name: "Vestments of the Sea-Witch", cat: "tierArmor" },
    { id: 30111, name: "Runetotem's Mantle", cat: "tierArmor" },
    { id: 30106, name: "Belt of One Hundred Deaths", cat: "tierArmor" },
    { id: 30110, name: "Coral Band of the Revived", cat: "ringsNeck" },
    { id: 30108, name: "Lightfathom Scepter", cat: "weapons" },
    { id: 30112, name: "Fang of Vashj", cat: "weapons" },
    { id: 30109, name: "Ring of Endless Coils", cat: "ringsNeck" },
    { id: 30113, name: "Krakken-Heart Breastplate", cat: "tierArmor" },
    { id: 30114, name: "Helm of the Vanquished Champion", cat: "tierArmor" },
    { id: 30115, name: "Helm of the Vanquished Defender", cat: "tierArmor" },
    { id: 30116, name: "Helm of the Vanquished Hero", cat: "tierArmor" },
    { id: 30018, name: "Lord Sanguinar's Claim", cat: "ringsNeck" },
    { id: 30021, name: "Boots of Effortless Striking", cat: "tierArmor" },
    { id: 30023, name: "Vestments of the Sea-Witch", cat: "tierArmor" },
  ],
  tk: [
    // Al'ar
    { id: 29925, name: "Phoenix-Wing Cloak", cat: "tierArmor" },
    { id: 29918, name: "Mindstorm Wristbands", cat: "tierArmor" },
    { id: 29921, name: "Fire Crest Breastplate", cat: "tierArmor" },
    { id: 29922, name: "Band of Al'ar", cat: "ringsNeck" },
    { id: 29920, name: "Phoenix-Ring of Rebirth", cat: "ringsNeck" },
    { id: 29923, name: "Talisman of the Sun King", cat: "ringsNeck" },
    { id: 29924, name: "Netherbane", cat: "weapons" },
    { id: 29949, name: "Arcanite Steam-Pistol", cat: "weapons" },
    { id: 32944, name: "Talon of the Phoenix", cat: "weapons" },
    { id: 29919, name: "Claw of the Phoenix", cat: "weapons" },
    { id: 32458, name: "Ashes of Al'ar", cat: "bags" },
    // Void Reaver
    { id: 29983, name: "Fel-Steel Warhelm", cat: "tierArmor" },
    { id: 29984, name: "Girdle of Zaetar", cat: "tierArmor" },
    { id: 29986, name: "Cowl of the Grand Engineer", cat: "tierArmor" },
    { id: 29985, name: "Void Reaver Greaves", cat: "tierArmor" },
    { id: 29987, name: "Girdle of Fallen Stars", cat: "tierArmor" },
    { id: 29988, name: "Wristguards of Determination", cat: "tierArmor" },
    { id: 29989, name: "Wristguards of Determination", cat: "tierArmor" },
    { id: 29990, name: "Warp-Spring Coil", cat: "trinkets" },
    { id: 30619, name: "Fel Reaver's Piston", cat: "trinkets" },
    { id: 30248, name: "Shoulders of the Vanquished Champion", cat: "tierArmor" },
    { id: 30249, name: "Shoulders of the Vanquished Defender", cat: "tierArmor" },
    { id: 30250, name: "Shoulders of the Vanquished Hero", cat: "tierArmor" },
    // High Astromancer Solarian
    { id: 29962, name: "Heartrazor", cat: "weapons" },
    { id: 29966, name: "Vambraces of Ending", cat: "tierArmor" },
    { id: 29950, name: "Greaves of the Bloodwarder", cat: "tierArmor" },
    { id: 29951, name: "Star-Soul Breeches", cat: "tierArmor" },
    { id: 29965, name: "Girdle of the Righteous Path", cat: "tierArmor" },
    { id: 29960, name: "Boots of the Resilient", cat: "tierArmor" },
    { id: 29963, name: "Solarian's Sapphire", cat: "ringsNeck" },
    { id: 29961, name: "Ethereum Life-Staff", cat: "weapons" },
    { id: 29964, name: "Void Star Talisman", cat: "trinkets" },
    { id: 29967, name: "Star-Strider Boots", cat: "tierArmor" },
    // Kael'thas Sunstrider
    { id: 29992, name: "Royal Cloak of the Sunstriders", cat: "tierArmor" },
    { id: 29989, name: "Thalassian Wildercloak", cat: "tierArmor" },
    { id: 29994, name: "Thalassian Ranger Gauntlets", cat: "tierArmor" },
    { id: 29995, name: "Leggings of Murderous Intent", cat: "tierArmor" },
    { id: 29991, name: "Royal Gauntlets of Silvermoon", cat: "tierArmor" },
    { id: 29998, name: "Royal Cloak of the Sunstriders", cat: "tierArmor" },
    { id: 29996, name: "Rod of the Sun King", cat: "weapons" },
    { id: 29993, name: "Twinblade of the Phoenix", cat: "weapons" },
    { id: 30236, name: "Chestguard of the Vanquished Champion", cat: "tierArmor" },
    { id: 30237, name: "Chestguard of the Vanquished Defender", cat: "tierArmor" },
    { id: 30238, name: "Chestguard of the Vanquished Hero", cat: "tierArmor" },
    { id: 29997, name: "Band of the Ranger-General", cat: "ringsNeck" },
    { id: 30015, name: "The Nexus Key", cat: "weapons" },
    { id: 30017, name: "Telonicus's Pendant of Mayhem", cat: "ringsNeck" },
    { id: 30007, name: "The Darkener's Grasp", cat: "tierArmor" },
  ],
  hyjal: [
    // Rage Winterchill
    { id: 30871, name: "Bracers of Martyrdom", cat: "tierArmor" },
    { id: 30870, name: "Cuffs of Devastation", cat: "tierArmor" },
    { id: 30863, name: "Deadly Cuffs", cat: "tierArmor" },
    { id: 30868, name: "Chronicle of Dark Secrets", cat: "offhand" },
    { id: 30864, name: "Bracers of the Pathfinder", cat: "tierArmor" },
    { id: 30869, name: "Fury of the Ursine", cat: "tierArmor" },
    { id: 30866, name: "Blood-Stained Pauldrons", cat: "tierArmor" },
    { id: 30862, name: "Blessed Adamantite Bracers", cat: "tierArmor" },
    { id: 30861, name: "Howling Wind Bracers", cat: "tierArmor" },
    { id: 30865, name: "Tracker's Blade", cat: "weapons" },
    { id: 30867, name: "Rejuvenating Bracers", cat: "tierArmor" },
    // Anetheron
    { id: 30884, name: "Hatefury Mantle", cat: "tierArmor" },
    { id: 30888, name: "Anetheron's Noose", cat: "tierArmor" },
    { id: 30879, name: "Don Alejandro's Money Belt", cat: "tierArmor" },
    { id: 30880, name: "Quickstrider Moccasins", cat: "tierArmor" },
    { id: 30878, name: "Glimmering Steel Mantle", cat: "tierArmor" },
    { id: 30874, name: "The Unbreakable Will", cat: "weapons" },
    { id: 30881, name: "Blade of Infamy", cat: "weapons" },
    { id: 30882, name: "Pillar of Ferocity", cat: "weapons" },
    { id: 30883, name: "Legguards of Endless Rage", cat: "tierArmor" },
    { id: 30885, name: "Archbishop's Slippers", cat: "tierArmor" },
    // Kaz'rogal
    { id: 30894, name: "Blue Suede Shoes", cat: "tierArmor" },
    { id: 30895, name: "Angelista's Sash", cat: "tierArmor" },
    { id: 30893, name: "Sun-Touched Chain Leggings", cat: "tierArmor" },
    { id: 30891, name: "Black Featherlight Boots", cat: "tierArmor" },
    { id: 30892, name: "Beast-Tamer's Shoulders", cat: "tierArmor" },
    { id: 30896, name: "Glory of the Defender", cat: "tierArmor" },
    { id: 30897, name: "Valestalker Girdle", cat: "tierArmor" },
    { id: 30898, name: "Shady Dealer's Pantaloons", cat: "tierArmor" },
    { id: 30899, name: "Don Rodrigo's Poncho", cat: "tierArmor" },
    { id: 30900, name: "Bow of the Verdant Keeper", cat: "weapons" },
    // Azgalor
    { id: 30914, name: "Belt of Seething Fury", cat: "tierArmor" },
    { id: 30916, name: "Leggings of Channeled Elements", cat: "tierArmor" },
    { id: 30917, name: "Razorfury Mantle", cat: "tierArmor" },
    { id: 30918, name: "Apostle of Argus", cat: "weapons" },
    { id: 30913, name: "Helm of Burning Righteousness", cat: "tierArmor" },
    { id: 30912, name: "Boundless Agony", cat: "weapons" },
    { id: 30911, name: "Soulshatter Vest", cat: "tierArmor" },
    { id: 30910, name: "Tempest of Chaos", cat: "weapons" },
    { id: 30909, name: "Antonidas's Aegis of Rapt Concentration", cat: "offhand" },
    { id: 30908, name: "Gloves of Unfailing Faith", cat: "tierArmor" },
    { id: 30907, name: "Mail of Fevered Pursuit", cat: "tierArmor" },
    // Archimonde
    { id: 30916, name: "Leggings of Eternity", cat: "tierArmor" },
    { id: 31092, name: "Helm of the Forgotten Conqueror", cat: "tierArmor" },
    { id: 31093, name: "Helm of the Forgotten Protector", cat: "tierArmor" },
    { id: 31097, name: "Helm of the Forgotten Vanquisher", cat: "tierArmor" },
    { id: 30905, name: "Midnight Chestguard", cat: "tierArmor" },
    { id: 30904, name: "Savior's Grasp", cat: "tierArmor" },
    { id: 30903, name: "Legguards of Endless Rage", cat: "tierArmor" },
    { id: 30902, name: "Cataclysm's Edge", cat: "weapons" },
    { id: 30901, name: "Bristleblitz Striker", cat: "weapons" },
    { id: 30906, name: "Shard of Azzinoth", cat: "weapons" },
  ],
  bt: [
    // High Warlord Naj'entus
    { id: 32239, name: "Slippers of the Seacaller", cat: "tierArmor" },
    { id: 32240, name: "Guise of the Tidal Lurker", cat: "tierArmor" },
    { id: 32377, name: "Mantle of Darkness", cat: "tierArmor" },
    { id: 32241, name: "Helm of Soothing Currents", cat: "tierArmor" },
    { id: 32234, name: "Fists of Mukoa", cat: "tierArmor" },
    { id: 32242, name: "Tide-Stomper's Greaves", cat: "tierArmor" },
    { id: 32232, name: "Eternium Shell Bracers", cat: "tierArmor" },
    { id: 32238, name: "Ring of Calming Waves", cat: "ringsNeck" },
    { id: 32237, name: "Ring of Captured Storms", cat: "ringsNeck" },
    { id: 32236, name: "Rising Tide", cat: "weapons" },
    { id: 32248, name: "Halberd of Desolation", cat: "weapons" },
    { id: 32270, name: "The Maelstrom's Fury", cat: "weapons" },
    // Supremus
    { id: 32256, name: "Wristbands of Divine Influence", cat: "tierArmor" },
    { id: 32252, name: "Nether Shadow Tunic", cat: "tierArmor" },
    { id: 32259, name: "Band of the Abyssal Lord", cat: "ringsNeck" },
    { id: 32251, name: "Wraps of Precise Flight", cat: "tierArmor" },
    { id: 32258, name: "Naturalist's Preserving Cinch", cat: "tierArmor" },
    { id: 32260, name: "Choker of Endless Nightmares", cat: "ringsNeck" },
    { id: 32261, name: "Pauldrons of Abyssal Fury", cat: "tierArmor" },
    { id: 32254, name: "The Brutalizer", cat: "weapons" },
    { id: 32262, name: "Syphon of the Nathrezim", cat: "weapons" },
    { id: 32255, name: "Felstone Bulwark", cat: "offhand" },
    { id: 32253, name: "Legionkiller", cat: "weapons" },
    // Shade of Akama
    { id: 32273, name: "Amice of Brilliant Light", cat: "tierArmor" },
    { id: 32278, name: "Grips of Silent Justice", cat: "tierArmor" },
    { id: 32279, name: "The Seeker's Wristguards", cat: "tierArmor" },
    { id: 32276, name: "Praetorian's Legguards", cat: "tierArmor" },
    { id: 32275, name: "Spiritwalker Gauntlets", cat: "tierArmor" },
    { id: 32274, name: "Focused Mana Bindings", cat: "tierArmor" },
    { id: 32280, name: "Wristbands of the Sentinel Huntress", cat: "tierArmor" },
    { id: 32282, name: "The Maelstrom's Fury", cat: "weapons" },
    { id: 32505, name: "Kilt of Immortal Nature", cat: "tierArmor" },
    // Teron Gorefiend
    { id: 32323, name: "Shadowmoon Destroyer's Drape", cat: "tierArmor" },
    { id: 32329, name: "Botanist's Gloves of Growth", cat: "tierArmor" },
    { id: 32327, name: "Robe of the Shadow Council", cat: "tierArmor" },
    { id: 32324, name: "Insidious Bands", cat: "tierArmor" },
    { id: 32328, name: "Girdle of Lordaeron's Fallen", cat: "tierArmor" },
    { id: 32326, name: "Gauntlets of Enforcement", cat: "tierArmor" },
    { id: 32330, name: "Softstep Boots of Tracking", cat: "tierArmor" },
    { id: 32348, name: "Soul Cleaver", cat: "weapons" },
    { id: 32325, name: "Rifle of the Stoic Guardian", cat: "weapons" },
    // Gurtogg Bloodboil
    { id: 32337, name: "Shroud of Forgiveness", cat: "tierArmor" },
    { id: 32338, name: "Blood-Cursed Shoulderpads", cat: "tierArmor" },
    { id: 32340, name: "Shadowtooth Trollskin Cuirass", cat: "tierArmor" },
    { id: 32339, name: "Belt of Primal Majesty", cat: "tierArmor" },
    { id: 32333, name: "Wristguards of Tranquil Thought", cat: "tierArmor" },
    { id: 32334, name: "Vest of Mounting Assault", cat: "tierArmor" },
    { id: 32335, name: "Unstoppable Aggressor's Ring", cat: "ringsNeck" },
    { id: 32341, name: "Girdle of Mighty Resolve", cat: "tierArmor" },
    { id: 32269, name: "Messenger of Fate", cat: "weapons" },
    { id: 32342, name: "Shadowmoon Insignia", cat: "trinkets" },
    { id: 32336, name: "Dragonscale-Encrusted Longblade", cat: "weapons" },
    // Reliquary of Souls
    { id: 32351, name: "Elunite Empowered Bracers", cat: "tierArmor" },
    { id: 32346, name: "Boneweave Girdle", cat: "tierArmor" },
    { id: 32349, name: "Translucent Spellthread Necklace", cat: "ringsNeck" },
    { id: 32362, name: "Naaru-Blessed Life Rod", cat: "weapons" },
    { id: 32361, name: "Blind-Seers Icon", cat: "offhand" },
    { id: 32352, name: "Naturewarden's Treads", cat: "tierArmor" },
    { id: 32517, name: "The Wavemender's Mantle", cat: "tierArmor" },
    { id: 32350, name: "Touch of Inspiration", cat: "weapons" },
    { id: 32363, name: "Naaru-Blessed Life Rod", cat: "weapons" },
    { id: 32353, name: "Grips of Damnation", cat: "tierArmor" },
    { id: 32354, name: "Crown of Empowered Fate", cat: "tierArmor" },
    // Mother Shahraz
    { id: 32367, name: "Leggings of Devastation", cat: "tierArmor" },
    { id: 32366, name: "Shadowmaster's Boots", cat: "tierArmor" },
    { id: 32365, name: "Heartshatter Breastplate", cat: "tierArmor" },
    { id: 32370, name: "Nadina's Pendant of Purity", cat: "ringsNeck" },
    { id: 32368, name: "Tome of the Lightbringer", cat: "relics" },
    { id: 32369, name: "Blade of Savagery", cat: "weapons" },
    { id: 32374, name: "Wand of Prismatic Focus", cat: "weapons" },
    { id: 32371, name: "Essence of the Immortals", cat: "trinkets" },
    // Illidari Council
    { id: 32331, name: "Cloak of the Illidari Council", cat: "tierArmor" },
    { id: 32378, name: "Helm of Soothing Currents", cat: "tierArmor" },
    { id: 32376, name: "Forest Prowler's Helm", cat: "tierArmor" },
    { id: 32373, name: "Helm of the Illidari Shatterer", cat: "tierArmor" },
    { id: 32505, name: "Madness of the Betrayer", cat: "trinkets" },
    { id: 32379, name: "Verdant Gloves", cat: "tierArmor" },
    { id: 32375, name: "Girdle of the Lightbearer", cat: "tierArmor" },
    { id: 32380, name: "Veil of Turning Leaves", cat: "tierArmor" },
    // Illidan Stormrage
    { id: 32837, name: "Warglaive of Azzinoth (MH)", cat: "weapons" },
    { id: 32838, name: "Warglaive of Azzinoth (OH)", cat: "weapons" },
    { id: 31089, name: "Chestguard of the Forgotten Conqueror", cat: "tierArmor" },
    { id: 31091, name: "Chestguard of the Forgotten Protector", cat: "tierArmor" },
    { id: 31090, name: "Chestguard of the Forgotten Vanquisher", cat: "tierArmor" },
    { id: 32471, name: "Shard of Azzinoth", cat: "weapons" },
    { id: 32500, name: "Crystal Spire of Karabor", cat: "weapons" },
    { id: 32374, name: "Zhar'doom, Greatstaff of the Devourer", cat: "weapons" },
    { id: 32483, name: "The Skull of Gul'dan", cat: "trinkets" },
    { id: 32496, name: "Memento of Tyrande", cat: "trinkets" },
    { id: 32497, name: "Stormrage Signet Ring", cat: "ringsNeck" },
    { id: 32524, name: "Shroud of the Highborne", cat: "tierArmor" },
    { id: 32525, name: "Cowl of the Illidari High Lord", cat: "tierArmor" },
    { id: 32235, name: "Cursed Vision of Sargeras", cat: "tierArmor" },
  ],
  sunwell: [
    // Kalecgos
    { id: 34848, name: "Bracers of the Forgotten Conqueror", cat: "tierArmor" },
    { id: 34851, name: "Bracers of the Forgotten Protector", cat: "tierArmor" },
    { id: 34852, name: "Bracers of the Forgotten Vanquisher", cat: "tierArmor" },
    { id: 34164, name: "Dragonscale-Encrusted Longblade", cat: "weapons" },
    { id: 34165, name: "Fang of Kalecgos", cat: "weapons" },
    { id: 34167, name: "Legplates of the Holy Juggernaut", cat: "tierArmor" },
    { id: 34169, name: "Breeches of Natural Aggression", cat: "tierArmor" },
    { id: 34170, name: "Pantaloons of Calming Strife", cat: "tierArmor" },
    { id: 34168, name: "Starstalker Legguards", cat: "tierArmor" },
    // Brutallus
    { id: 34853, name: "Belt of the Forgotten Conqueror", cat: "tierArmor" },
    { id: 34854, name: "Belt of the Forgotten Protector", cat: "tierArmor" },
    { id: 34855, name: "Belt of the Forgotten Vanquisher", cat: "tierArmor" },
    { id: 34176, name: "Reign of Misery", cat: "weapons" },
    { id: 34177, name: "Collar of the Pit Lord", cat: "ringsNeck" },
    { id: 34178, name: "Felfury Legplates", cat: "tierArmor" },
    { id: 34179, name: "Heart of the Pit", cat: "trinkets" },
    { id: 34180, name: "Felmyst's Cindersash", cat: "tierArmor" },
    // Felmyst
    { id: 34856, name: "Boots of the Forgotten Conqueror", cat: "tierArmor" },
    { id: 34857, name: "Boots of the Forgotten Protector", cat: "tierArmor" },
    { id: 34858, name: "Boots of the Forgotten Vanquisher", cat: "tierArmor" },
    { id: 34184, name: "Brooch of the Highborne", cat: "ringsNeck" },
    { id: 34185, name: "Sword Breaker's Bulwark", cat: "offhand" },
    { id: 34186, name: "Chain Links of the Tumultuous Storm", cat: "tierArmor" },
    { id: 34188, name: "Leggings of the Immortal Night", cat: "tierArmor" },
    { id: 34333, name: "Borderland Fortress Grips", cat: "tierArmor" },
    // Eredar Twins
    { id: 34345, name: "Crown of Anasterian", cat: "tierArmor" },
    { id: 34189, name: "Band of Ruinous Delight", cat: "ringsNeck" },
    { id: 34193, name: "Spaulders of Reclamation", cat: "tierArmor" },
    { id: 34192, name: "Pauldrons of Perseverance", cat: "tierArmor" },
    { id: 34190, name: "Crimson Paragon's Cover", cat: "tierArmor" },
    { id: 34191, name: "Shiv of Exsanguination", cat: "weapons" },
    { id: 34194, name: "Blade of Life's Inevitability", cat: "weapons" },
    { id: 34196, name: "Legplates of the Immortal Night", cat: "tierArmor" },
    { id: 34197, name: "Equilibrium Epaulets", cat: "tierArmor" },
    // M'uru
    { id: 34230, name: "Bracers of Slaughter", cat: "tierArmor" },
    { id: 34429, name: "Shifting Naaru Sliver", cat: "trinkets" },
    { id: 34427, name: "Blackened Naaru Sliver", cat: "trinkets" },
    { id: 34428, name: "Steely Naaru Sliver", cat: "trinkets" },
    { id: 34430, name: "Glimmering Naaru Sliver", cat: "trinkets" },
    { id: 34210, name: "Muramasa", cat: "weapons" },
    { id: 34214, name: "Apolyon, the Soul-Render", cat: "weapons" },
    { id: 34204, name: "Fel Conquerer Raiments", cat: "tierArmor" },
    { id: 34205, name: "Mounting Vengeance", cat: "tierArmor" },
    { id: 34206, name: "Clutch of Demise", cat: "tierArmor" },
    { id: 34207, name: "Swiftblade of Zeal", cat: "weapons" },
    { id: 34208, name: "Sin'dorei Pendant of Triumph", cat: "ringsNeck" },
    { id: 34209, name: "Sin'dorei Pendant of Conquest", cat: "ringsNeck" },
    // Kil'jaeden
    { id: 34334, name: "Thori'dal, the Stars' Fury", cat: "weapons" },
    { id: 34329, name: "Crux of the Apocalypse", cat: "weapons" },
    { id: 34247, name: "Apolyon, the Soul-Render", cat: "weapons" },
    { id: 34244, name: "Duplicitous Guise", cat: "tierArmor" },
    { id: 34245, name: "Cover of Ursol the Wise", cat: "tierArmor" },
    { id: 34340, name: "Dark Conjuror's Collar", cat: "tierArmor" },
    { id: 34339, name: "Cowl of Light's Purity", cat: "tierArmor" },
    { id: 34342, name: "Handguards of the Dawn", cat: "tierArmor" },
    { id: 34344, name: "Handguards of the Dawn", cat: "tierArmor" },
    { id: 34341, name: "Borderland Fortress Grips", cat: "tierArmor" },
    { id: 34343, name: "Thalassian Ranger Gauntlets", cat: "tierArmor" },
    { id: 34163, name: "Sunmote", cat: "bags" },
  ],
  za: [
    // Nalorakk
    { id: 33203, name: "Robes of Heavenly Purpose", cat: "tierArmor" },
    { id: 33285, name: "Fury of the Ursine", cat: "tierArmor" },
    { id: 33211, name: "Bladeangel's Money Belt", cat: "tierArmor" },
    { id: 33206, name: "Pauldrons of Primal Fury", cat: "tierArmor" },
    { id: 33191, name: "Jungle Stompers", cat: "tierArmor" },
    { id: 33640, name: "Fury", cat: "weapons" },
    // Akil'zon
    { id: 33214, name: "Brooch of Nature's Mercy", cat: "ringsNeck" },
    { id: 33281, name: "Signet of the Last Defender", cat: "ringsNeck" },
    { id: 33215, name: "Bloodstained Elven Battlevest", cat: "tierArmor" },
    { id: 33293, name: "Signet of Primal Wrath", cat: "ringsNeck" },
    { id: 33283, name: "Akil'zon's Talonblade", cat: "weapons" },
    { id: 33216, name: "Mojo-Mender's Mask", cat: "tierArmor" },
    // Jan'alai
    { id: 33357, name: "Footpads of Madness", cat: "tierArmor" },
    { id: 33356, name: "Helm of Natural Regeneration", cat: "tierArmor" },
    { id: 33354, name: "Wub's Cursed Hexblade", cat: "weapons" },
    { id: 33359, name: "Loop of Cursed Apathy", cat: "ringsNeck" },
    { id: 33355, name: "Enamelled Disc of Mojo", cat: "offhand" },
    // Halazzi
    { id: 33299, name: "Robe of Departed Spirits", cat: "tierArmor" },
    { id: 33301, name: "Avalanche Leggings", cat: "tierArmor" },
    { id: 33297, name: "The Savage's Choker", cat: "ringsNeck" },
    { id: 33298, name: "Shoulderpads of Dancing Blades", cat: "tierArmor" },
    { id: 33300, name: "Spaulders of the Advocate", cat: "tierArmor" },
    { id: 33303, name: "Skullshatter Warboots", cat: "tierArmor" },
    // Hex Lord Malacrass
    { id: 33590, name: "Cloak of Fiends", cat: "tierArmor" },
    { id: 33591, name: "Staff of Dark Mending", cat: "weapons" },
    { id: 33592, name: "Battleworn Tuskguard", cat: "tierArmor" },
    { id: 33593, name: "Shadowcaster's Drape", cat: "tierArmor" },
    { id: 33466, name: "Loop of the Cursed Apathy", cat: "ringsNeck" },
    { id: 33589, name: "Recoilless Rocket Ripper X-54", cat: "weapons" },
    // Zul'jin
    { id: 33467, name: "Blade of Twisted Visions", cat: "weapons" },
    { id: 33468, name: "Chestguard of Hidden Purpose", cat: "tierArmor" },
    { id: 33469, name: "Grimgrin Faceguard", cat: "tierArmor" },
    { id: 33470, name: "Hauberk of the Empire's Champion", cat: "tierArmor" },
    { id: 33471, name: "Two-Toed Sandals", cat: "tierArmor" },
    { id: 33472, name: "Ancient Aqir Artifact", cat: "trinkets" },
    { id: 33473, name: "Berserker's Call", cat: "trinkets" },
    { id: 33828, name: "Hex Lord's Voodoo Pauldrons", cat: "tierArmor" },
    { id: 33829, name: "Tuskbreaker", cat: "weapons" },
    { id: 33830, name: "Ancient Amani Longbow", cat: "weapons" },
    { id: 33831, name: "Amani Punisher", cat: "weapons" },
  ]
};

const DKP_CATEGORIES = {
  onTime: { label: "On-Time", dkp: 15 },
  consumesFull: { label: "Consumes (Full)", dkp: 50 },
  consumesPartial: { label: "Consumes (Partial)", dkp: 25 },
  avgParse60: { label: "AVG 60+ Parse", dkp: 15 },
  bossKill: { label: "Boss Kill", dkp: 10 },
  progBossKill: { label: "Prog Boss Kill", dkp: 10 },
  bench: { label: "Bench", dkp: 25 }
};

const ITEM_CATS = {
  weapons: { label: "Weapons", bis: 50, nonBis: 25 },
  trinkets: { label: "Trinkets", bis: 50, nonBis: 25 },
  tierArmor: { label: "Tier Token + Armor", bis: 30, nonBis: 15 },
  ringsNeck: { label: "Rings + Neck", bis: 30, nonBis: 15 },
  offhand: { label: "Off-Hand / Shield / Wand", bis: 30, nonBis: 15 },
  relics: { label: "Relic / Totem / Idol", bis: 10, nonBis: 5 },
  bags: { label: "Bags + Toys", bis: 5, nonBis: 5 },
  recipes: { label: "Recipes", bis: 5, nonBis: 5 },
  unwanted: { label: "Unwanted", bis: 5, nonBis: 5 }
};

const WOW_CLASSES = [
  { name: "Warrior", color: "#C79C6E" },
  { name: "Paladin", color: "#F58CBA" },
  { name: "Hunter", color: "#ABD473" },
  { name: "Rogue", color: "#FFF569" },
  { name: "Priest", color: "#FFFFFF" },
  { name: "Shaman", color: "#0070DE" },
  { name: "Mage", color: "#69CCF0" },
  { name: "Warlock", color: "#9482C9" },
  { name: "Druid", color: "#FF7D0A" }
];


// ============================================================================
// UTILITIES
// ============================================================================

const genId = () => Math.random().toString(36).substr(2, 9);
const getClassColor = (cn) => WOW_CLASSES.find(c => c.name === cn)?.color || '#FFF';
const fmtDate = (d) => new Date(d).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
const fmtDateTime = (d) => new Date(d).toLocaleString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
const calcCost = (dkp, cat, isBis) => Math.floor(dkp * ((isBis ? ITEM_CATS[cat]?.bis : ITEM_CATS[cat]?.nonBis) || 5) / 100);

const useStorage = (key, init) => {
  const [val, setVal] = useState(() => {
    try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : init; }
    catch { return init; }
  });
  const set = (v) => { const nv = typeof v === 'function' ? v(val) : v; setVal(nv); localStorage.setItem(key, JSON.stringify(nv)); };
  return [val, set];
};

// ============================================================================
// ICONS
// ============================================================================

const Icons = {
  Anchor: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-8 h-8"><circle cx="12" cy="5" r="3"/><line x1="12" y1="22" x2="12" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></svg>,
  Users: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
  Calendar: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
  Sword: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><path d="M14.5 17.5L3 6V3h3l11.5 11.5M13 19l6-6M16 16l4 4M19 21l2-2"/></svg>,
  History: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
  Lock: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
  Settings: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
  Logout: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
  Plus: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  Minus: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  Trash: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2v2"/></svg>,
  Check: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><polyline points="20,6 9,17 4,12"/></svg>,
  X: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
  ChevDown: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4"><polyline points="6 9 12 15 18 9"/></svg>,
  ChevUp: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4"><polyline points="18 15 12 9 6 15"/></svg>,
  Save: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
};

// ============================================================================
// MODAL COMPONENT
// ============================================================================

const Modal = ({ title, onClose, children }) => (
  <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div className="bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-amber-400">{title}</h2>
        <button onClick={onClose} className="text-slate-400 hover:text-slate-200 p-1"><Icons.X /></button>
      </div>
      {children}
    </div>
  </div>
);

// ============================================================================
// STANDINGS TAB
// ============================================================================

const StandingsTab = ({ raiders, isAdmin, onUpdateDKP, onRemove, onPromote }) => {
  const [search, setSearch] = useState('');
  const [classFilter, setClassFilter] = useState('all');

  const filtered = useMemo(() => {
    return [...raiders]
      .filter(r => r.name.toLowerCase().includes(search.toLowerCase()) && (classFilter === 'all' || r.class === classFilter))
      .sort((a, b) => b.dkp - a.dkp);
  }, [raiders, search, classFilter]);

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold text-amber-400">DKP Standings</h2>
          <p className="text-slate-400 text-sm mt-1">{raiders.length} total raiders</p>
        </div>
        <div className="flex flex-wrap gap-3">
          <input type="text" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)}
            className="px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-100 placeholder-slate-500 focus:outline-none focus:border-amber-500/50 text-sm" />
          <select value={classFilter} onChange={e => setClassFilter(e.target.value)}
            className="px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50 text-sm">
            <option value="all">All Classes</option>
            {WOW_CLASSES.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}
          </select>
        </div>
      </div>

      <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="bg-slate-900/50 border-b border-slate-700/50">
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">#</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Raider</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Class</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Rank</th>
                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">DKP</th>
                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Raids</th>
                {isAdmin && <th className="px-4 py-3 text-center text-xs font-semibold text-slate-400 uppercase">Actions</th>}
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-700/30">
              {filtered.length === 0 ? (
                <tr><td colSpan={isAdmin ? 7 : 6} className="px-4 py-12 text-center text-slate-500">
                  {raiders.length === 0 ? 'No raiders added yet' : 'No results'}
                </td></tr>
              ) : filtered.map((r, i) => (
                <tr key={r.id} className="hover:bg-slate-700/20 transition-colors">
                  <td className="px-4 py-3">
                    <span className={`inline-flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold ${
                      i === 0 ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' :
                      i === 1 ? 'bg-slate-400/20 text-slate-300 border border-slate-400/30' :
                      i === 2 ? 'bg-amber-700/20 text-amber-600 border border-amber-700/30' : 'bg-slate-700/50 text-slate-400'
                    }`}>{i + 1}</span>
                  </td>
                  <td className="px-4 py-3 font-semibold text-slate-100">{r.name}</td>
                  <td className="px-4 py-3">
                    <span className="px-2 py-1 rounded text-sm font-medium" style={{ color: getClassColor(r.class), backgroundColor: `${getClassColor(r.class)}15` }}>{r.class}</span>
                  </td>
                  <td className="px-4 py-3">
                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                      r.rank === 'Trial' ? 'bg-yellow-500/20 text-yellow-400' :
                      r.rank === 'Officer' ? 'bg-purple-500/20 text-purple-400' : 'bg-green-500/20 text-green-400'
                    }`}>{r.rank}</span>
                  </td>
                  <td className="px-4 py-3 text-right text-lg font-bold text-amber-400">{r.dkp}</td>
                  <td className="px-4 py-3 text-right text-slate-400">{r.raidCount}</td>
                  {isAdmin && (
                    <td className="px-4 py-3">
                      <div className="flex items-center justify-center gap-1">
                        <button onClick={() => onUpdateDKP(r.id, 10)} className="p-1.5 text-green-400 hover:bg-green-500/20 rounded" title="+10 DKP"><Icons.Plus /></button>
                        <button onClick={() => onUpdateDKP(r.id, -10)} className="p-1.5 text-red-400 hover:bg-red-500/20 rounded" title="-10 DKP"><Icons.Minus /></button>
                        {r.rank === 'Trial' && <button onClick={() => onPromote(r.id)} className="p-1.5 text-amber-400 hover:bg-amber-500/20 rounded" title="Promote"><Icons.Check /></button>}
                        <button onClick={() => onRemove(r.id)} className="p-1.5 text-red-400 hover:bg-red-500/20 rounded" title="Remove"><Icons.Trash /></button>
                      </div>
                    </td>
                  )}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
        <h3 className="text-lg font-semibold text-amber-400 mb-4">Item Cost Reference</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          {Object.entries(ITEM_CATS).map(([k, v]) => (
            <div key={k} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg">
              <span className="text-slate-300 text-sm">{v.label}</span>
              <div className="text-sm"><span className="text-amber-400">BiS: {v.bis}%</span><span className="text-slate-500 mx-2">|</span><span className="text-slate-400">Other: {v.nonBis}%</span></div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// ============================================================================
// RAIDS TAB
// ============================================================================

const RaidsTab = ({ scheduled, raiders, isAdmin, onSchedule, onRemove, onUpdateScheduled }) => {
  const [showModal, setShowModal] = useState(false);
  const [editingRaid, setEditingRaid] = useState(null);
  const [expandedRaid, setExpandedRaid] = useState(null);
  
  // Form state
  const [raidType, setRaidType] = useState('karazhan');
  const [dateTime, setDateTime] = useState('');
  const [notes, setNotes] = useState('');
  const [selectedRoster, setSelectedRoster] = useState([]);

  const now = new Date();
  const upcoming = useMemo(() => scheduled.filter(r => new Date(r.dateTime) > now).sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime)), [scheduled]);
  const pastScheduled = useMemo(() => scheduled.filter(r => new Date(r.dateTime) <= now).sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime)), [scheduled]);

  const resetForm = () => {
    setRaidType('karazhan');
    setDateTime('');
    setNotes('');
    setSelectedRoster([]);
    setEditingRaid(null);
  };

  const openNewRaidModal = () => {
    resetForm();
    setShowModal(true);
  };

  const openEditModal = (raid) => {
    setEditingRaid(raid.id);
    setRaidType(raid.raidType);
    setDateTime(raid.dateTime);
    setNotes(raid.notes || '');
    setSelectedRoster(raid.roster || []);
    setShowModal(true);
  };

  const toggleRosterMember = (raiderId) => {
    setSelectedRoster(prev => 
      prev.includes(raiderId) ? prev.filter(id => id !== raiderId) : [...prev, raiderId]
    );
  };

  const selectAllRaiders = () => setSelectedRoster(raiders.map(r => r.id));
  const clearRoster = () => setSelectedRoster([]);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!dateTime) return;
    
    if (editingRaid) {
      onUpdateScheduled(editingRaid, { raidType, dateTime, notes, roster: selectedRoster });
    } else {
      onSchedule({ raidType, dateTime, notes, roster: selectedRoster });
    }
    
    setShowModal(false);
    resetForm();
  };

  const getRaiderName = (id) => raiders.find(r => r.id === id)?.name || 'Unknown';
  const getRaiderClass = (id) => raiders.find(r => r.id === id)?.class || null;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold text-amber-400">Raid Schedule</h2>
          <p className="text-slate-400 text-sm mt-1">{upcoming.length} upcoming raids</p>
        </div>
        {isAdmin && (
          <button onClick={openNewRaidModal} className="flex items-center gap-2 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg transition-colors">
            <Icons.Plus /> Schedule Raid
          </button>
        )}
      </div>

      {/* Server Time Notice */}
      <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3 flex items-center gap-2">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5 text-blue-400">
          <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
        </svg>
        <span className="text-blue-300 text-sm">All raid times are displayed in <span className="font-semibold text-blue-200">SERVER TIME</span>. Please convert to your local timezone.</span>
      </div>

      {/* Upcoming Raids */}
      <div className="space-y-4">
        <h3 className="text-lg font-semibold text-slate-300">Upcoming Raids</h3>
        {upcoming.length === 0 ? (
          <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-8 text-center text-slate-500">No upcoming raids scheduled</div>
        ) : (
          <div className="grid gap-4">
            {upcoming.map((raid, i) => {
              const isExpanded = expandedRaid === raid.id;
              const rosterCount = raid.roster?.length || 0;
              
              return (
                <div key={raid.id} className={`bg-slate-800/50 border rounded-xl overflow-hidden ${i === 0 ? 'border-amber-500/50 ring-1 ring-amber-500/20' : 'border-slate-700/50'}`}>
                  <div className="p-6">
                    <div className="flex items-start justify-between">
                      <div className="flex items-start gap-4">
                        <div className={`p-3 rounded-lg ${i === 0 ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-700/50 text-slate-400'}`}><Icons.Calendar /></div>
                        <div>
                          <h4 className="text-lg font-semibold text-slate-100">
                            {TBC_RAIDS[raid.raidType]?.name}
                            {i === 0 && <span className="ml-2 px-2 py-0.5 text-xs bg-amber-500/20 text-amber-400 rounded-full">Next Up</span>}
                          </h4>
                          <p className="text-amber-400 font-medium mt-1">{fmtDateTime(raid.dateTime)} <span className="text-amber-600 text-sm">(Server Time)</span></p>
                          {raid.notes && <p className="text-slate-400 text-sm mt-2">{raid.notes}</p>}
                          {rosterCount > 0 && (
                            <button 
                              onClick={() => setExpandedRaid(isExpanded ? null : raid.id)}
                              className="mt-2 text-sm text-slate-400 hover:text-slate-200 flex items-center gap-1"
                            >
                              <Icons.Users /> {rosterCount} raiders signed up
                              {isExpanded ? <Icons.ChevUp /> : <Icons.ChevDown />}
                            </button>
                          )}
                        </div>
                      </div>
                      {isAdmin && (
                        <div className="flex items-center gap-2">
                          <button onClick={() => openEditModal(raid)} className="p-2 text-amber-400 hover:bg-amber-500/20 rounded-lg" title="Edit Raid">
                            <Icons.Edit />
                          </button>
                          <button onClick={() => onRemove(raid.id)} className="p-2 text-red-400 hover:bg-red-500/20 rounded-lg" title="Delete Raid">
                            <Icons.Trash />
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  {/* Expanded Roster View */}
                  {isExpanded && raid.roster && raid.roster.length > 0 && (
                    <div className="border-t border-slate-700/50 p-4 bg-slate-900/30">
                      <h5 className="text-sm font-semibold text-slate-400 uppercase mb-3">Roster</h5>
                      <div className="flex flex-wrap gap-2">
                        {raid.roster.map(raiderId => (
                          <span 
                            key={raiderId} 
                            className="px-3 py-1 rounded-full text-sm font-medium"
                            style={{ 
                              color: getClassColor(getRaiderClass(raiderId)), 
                              backgroundColor: `${getClassColor(getRaiderClass(raiderId))}20` 
                            }}
                          >
                            {getRaiderName(raiderId)}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* Past Raids */}
      {pastScheduled.length > 0 && (
        <div className="space-y-4">
          <h3 className="text-lg font-semibold text-slate-300">Past Scheduled Raids</h3>
          <div className="grid gap-3 opacity-60">
            {pastScheduled.slice(0, 5).map(raid => (
              <div key={raid.id} className="bg-slate-800/30 border border-slate-700/30 rounded-lg p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <span className="font-medium text-slate-300">{TBC_RAIDS[raid.raidType]?.name}</span>
                    <span className="text-slate-500 text-sm ml-3">{fmtDateTime(raid.dateTime)}</span>
                    {raid.roster?.length > 0 && <span className="text-slate-500 text-sm ml-2">({raid.roster.length} raiders)</span>}
                  </div>
                  {isAdmin && (
                    <button onClick={() => onRemove(raid.id)} className="p-1.5 text-red-400/50 hover:text-red-400 hover:bg-red-500/20 rounded">
                      <Icons.Trash />
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Schedule/Edit Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold text-amber-400">{editingRaid ? 'Edit Scheduled Raid' : 'Schedule New Raid'}</h2>
              <button onClick={() => { setShowModal(false); resetForm(); }} className="text-slate-400 hover:text-slate-200 p-1"><Icons.X /></button>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-400 mb-2">Raid</label>
                <select value={raidType} onChange={e => setRaidType(e.target.value)} className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50">
                  {Object.entries(TBC_RAIDS).map(([k, v]) => <option key={k} value={k}>{v.name}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-400 mb-2">
                  Date & Time <span className="text-amber-400">(Server Time)</span>
                </label>
                <input 
                  type="datetime-local" 
                  value={dateTime} 
                  onChange={e => setDateTime(e.target.value)} 
                  required 
                  className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50" 
                />
                <p className="text-xs text-slate-500 mt-1">Enter the time in server time. Raiders should convert to their local timezone.</p>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-400 mb-2">Notes (optional)</label>
                <textarea 
                  value={notes} 
                  onChange={e => setNotes(e.target.value)} 
                  rows={2} 
                  placeholder="Additional notes..." 
                  className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50 resize-none" 
                />
              </div>

              {/* Roster Selection */}
              <div>
                <div className="flex items-center justify-between mb-2">
                  <label className="block text-sm font-medium text-slate-400">
                    Roster <span className="text-slate-500">({selectedRoster.length} selected)</span>
                  </label>
                  <div className="flex gap-2">
                    <button type="button" onClick={selectAllRaiders} className="px-2 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded text-slate-300">Select All</button>
                    <button type="button" onClick={clearRoster} className="px-2 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded text-slate-300">Clear</button>
                  </div>
                </div>
                
                <div className="max-h-48 overflow-y-auto bg-slate-900/50 rounded-lg border border-slate-700/50 p-3">
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    {raiders.map(raider => (
                      <button
                        key={raider.id}
                        type="button"
                        onClick={() => toggleRosterMember(raider.id)}
                        className={`p-2 rounded-lg text-left text-sm transition-colors ${
                          selectedRoster.includes(raider.id)
                            ? 'bg-amber-500/20 border border-amber-500/50'
                            : 'bg-slate-800/50 border border-slate-700/30 hover:border-slate-600'
                        }`}
                      >
                        <span style={{ color: getClassColor(raider.class) }} className="font-medium">{raider.name}</span>
                        <span className="text-slate-500 text-xs ml-1">({raider.rank})</span>
                      </button>
                    ))}
                  </div>
                  {raiders.length === 0 && (
                    <p className="text-center text-slate-500 py-4">No raiders available. Add raiders first.</p>
                  )}
                </div>
              </div>

              <div className="flex gap-3 pt-2">
                <button type="button" onClick={() => { setShowModal(false); resetForm(); }} className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg">Cancel</button>
                <button type="submit" className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg">
                  {editingRaid ? 'Save Changes' : 'Schedule Raid'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

// Add Edit icon to Icons object
Icons.Edit = () => (
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
  </svg>
);

// ============================================================================
// HISTORY TAB
// ============================================================================

const HistoryTab = ({ raidHistory, lootHistory, raiders, isAdmin, onEditRaid }) => {
  const [expanded, setExpanded] = useState(null);
  const [editingRaid, setEditingRaid] = useState(null);
  const [showChangelog, setShowChangelog] = useState(null);
  
  // Edit form state
  const [editParticipants, setEditParticipants] = useState([]);
  const [editBosses, setEditBosses] = useState([]);
  const [editProgBosses, setEditProgBosses] = useState([]);
  
  const getName = (id) => raiders.find(r => r.id === id)?.name || 'Unknown';
  const getRaidLoot = (raidId) => lootHistory.filter(l => l.raidId === raidId);

  const startEditing = (raid) => {
    setEditingRaid(raid.id);
    setEditParticipants(raid.participants.map(p => ({ ...p })));
    setEditBosses([...(raid.bossesKilled || [])]);
    setEditProgBosses([...(raid.progBosses || [])]);
  };

  const cancelEditing = () => {
    setEditingRaid(null);
    setEditParticipants([]);
    setEditBosses([]);
    setEditProgBosses([]);
  };

  const updateParticipantDKP = (raiderId, newDkp) => {
    setEditParticipants(prev => prev.map(p => 
      p.raiderId === raiderId ? { ...p, dkpEarned: Math.max(0, parseInt(newDkp) || 0) } : p
    ));
  };

  const removeParticipant = (raiderId) => {
    setEditParticipants(prev => prev.filter(p => p.raiderId !== raiderId));
  };

  const addParticipant = (raiderId) => {
    if (editParticipants.find(p => p.raiderId === raiderId)) return;
    setEditParticipants(prev => [...prev, { raiderId, dkpEarned: 0, bonuses: {} }]);
  };

  const toggleBoss = (boss) => {
    setEditBosses(prev => prev.includes(boss) ? prev.filter(b => b !== boss) : [...prev, boss]);
    if (editBosses.includes(boss)) {
      setEditProgBosses(prev => prev.filter(b => b !== boss));
    }
  };

  const toggleProgBoss = (boss) => {
    setEditProgBosses(prev => prev.includes(boss) ? prev.filter(b => b !== boss) : [...prev, boss]);
  };

  const saveEdits = (raid) => {
    const changes = [];
    const originalRaid = raidHistory.find(r => r.id === raid.id);
    
    // Check for participant changes
    const origParticipantIds = originalRaid.participants.map(p => p.raiderId);
    const newParticipantIds = editParticipants.map(p => p.raiderId);
    
    // Added participants
    const addedIds = newParticipantIds.filter(id => !origParticipantIds.includes(id));
    addedIds.forEach(id => {
      const p = editParticipants.find(x => x.raiderId === id);
      changes.push(`Added ${getName(id)} (+${p.dkpEarned} DKP)`);
    });
    
    // Removed participants
    const removedIds = origParticipantIds.filter(id => !newParticipantIds.includes(id));
    removedIds.forEach(id => {
      const origP = originalRaid.participants.find(x => x.raiderId === id);
      changes.push(`Removed ${getName(id)} (was +${origP.dkpEarned} DKP)`);
    });
    
    // DKP changes for existing participants
    editParticipants.forEach(p => {
      const origP = originalRaid.participants.find(x => x.raiderId === p.raiderId);
      if (origP && origP.dkpEarned !== p.dkpEarned) {
        changes.push(`${getName(p.raiderId)}: DKP changed from +${origP.dkpEarned} to +${p.dkpEarned}`);
      }
    });
    
    // Boss changes
    const origBosses = originalRaid.bossesKilled || [];
    const addedBosses = editBosses.filter(b => !origBosses.includes(b));
    const removedBosses = origBosses.filter(b => !editBosses.includes(b));
    if (addedBosses.length > 0) changes.push(`Added bosses: ${addedBosses.join(', ')}`);
    if (removedBosses.length > 0) changes.push(`Removed bosses: ${removedBosses.join(', ')}`);
    
    // Prog boss changes
    const origProgBosses = originalRaid.progBosses || [];
    const addedProgBosses = editProgBosses.filter(b => !origProgBosses.includes(b));
    const removedProgBosses = origProgBosses.filter(b => !editProgBosses.includes(b));
    if (addedProgBosses.length > 0) changes.push(`Marked as progression: ${addedProgBosses.join(', ')}`);
    if (removedProgBosses.length > 0) changes.push(`Unmarked as progression: ${removedProgBosses.join(', ')}`);

    if (changes.length === 0) {
      cancelEditing();
      return;
    }

    const editEntry = {
      timestamp: new Date().toISOString(),
      changes
    };

    onEditRaid(raid.id, {
      participants: editParticipants,
      bossesKilled: editBosses,
      progBosses: editProgBosses
    }, editEntry);

    cancelEditing();
  };

  const nonParticipants = (raid) => {
    const participantIds = editParticipants.map(p => p.raiderId);
    return raiders.filter(r => !participantIds.includes(r.id));
  };

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold text-amber-400">Raid History</h2>
        <p className="text-slate-400 text-sm mt-1">{raidHistory.length} completed raids</p>
      </div>

      {raidHistory.length === 0 ? (
        <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-12 text-center text-slate-500">No raids completed yet</div>
      ) : (
        <div className="space-y-4">
          {raidHistory.map(raid => {
            const isExp = expanded === raid.id;
            const isEditing = editingRaid === raid.id;
            const loot = getRaidLoot(raid.id);
            const totalDKP = raid.participants.reduce((s, p) => s + p.dkpEarned, 0);
            const bosses = TBC_RAIDS[raid.raidType]?.bosses || [];

            return (
              <div key={raid.id} className="bg-slate-800/50 border border-slate-700/50 rounded-xl overflow-hidden">
                <button onClick={() => setExpanded(isExp ? null : raid.id)} className="w-full p-6 flex items-center justify-between hover:bg-slate-700/20 transition-colors">
                  <div className="flex items-center gap-4">
                    <div className="p-3 bg-amber-500/20 rounded-lg text-amber-400"><Icons.History /></div>
                    <div className="text-left">
                      <h3 className="text-lg font-semibold text-slate-100">
                        {TBC_RAIDS[raid.raidType]?.name}
                        {raid.editHistory && raid.editHistory.length > 0 && (
                          <span className="ml-2 px-2 py-0.5 text-xs bg-blue-500/20 text-blue-400 rounded-full">Edited</span>
                        )}
                      </h3>
                      <p className="text-slate-400 text-sm">{fmtDateTime(raid.completedAt)}</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-6">
                    <div className="text-right">
                      <p className="text-amber-400 font-semibold">{totalDKP} DKP</p>
                      <p className="text-slate-500 text-sm">{raid.participants.length} raiders</p>
                    </div>
                    <div className="text-slate-400">{isExp ? <Icons.ChevUp /> : <Icons.ChevDown />}</div>
                  </div>
                </button>

                {isExp && (
                  <div className="border-t border-slate-700/50 p-6 space-y-6">
                    {/* Admin Edit Controls */}
                    {isAdmin && !isEditing && (
                      <div className="flex items-center justify-between">
                        <div className="flex gap-2">
                          <button onClick={() => startEditing(raid)} className="flex items-center gap-2 px-4 py-2 bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 rounded-lg border border-amber-500/30 text-sm">
                            <Icons.Edit /> Edit Raid
                          </button>
                          {raid.editHistory && raid.editHistory.length > 0 && (
                            <button onClick={() => setShowChangelog(showChangelog === raid.id ? null : raid.id)} className="flex items-center gap-2 px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-lg border border-blue-500/30 text-sm">
                              <Icons.History /> View Changelog ({raid.editHistory.length})
                            </button>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Changelog Display */}
                    {showChangelog === raid.id && raid.editHistory && (
                      <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 space-y-4">
                        <h4 className="text-sm font-semibold text-blue-400 uppercase">Edit Changelog</h4>
                        {raid.editHistory.map((edit, idx) => (
                          <div key={idx} className="border-l-2 border-blue-500/50 pl-4 py-2">
                            <p className="text-xs text-blue-300 mb-2">{fmtDateTime(edit.timestamp)}</p>
                            <ul className="space-y-1">
                              {edit.changes.map((change, cIdx) => (
                                <li key={cIdx} className="text-sm text-slate-300"> {change}</li>
                              ))}
                            </ul>
                          </div>
                        ))}
                      </div>
                    )}

                    {/* Editing Mode */}
                    {isEditing ? (
                      <div className="space-y-6">
                        {/* Edit Participants */}
                        <div>
                          <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Edit Participants & DKP</h4>
                          <div className="space-y-2 mb-4">
                            {editParticipants.map(p => (
                              <div key={p.raiderId} className="flex items-center gap-3 p-3 bg-slate-900/50 rounded-lg">
                                <span className="text-slate-300 flex-1">{getName(p.raiderId)}</span>
                                <div className="flex items-center gap-2">
                                  <span className="text-slate-500 text-sm">DKP:</span>
                                  <input
                                    type="number"
                                    value={p.dkpEarned}
                                    onChange={(e) => updateParticipantDKP(p.raiderId, e.target.value)}
                                    className="w-20 px-2 py-1 bg-slate-800 border border-slate-600 rounded text-amber-400 text-center"
                                  />
                                  <button onClick={() => removeParticipant(p.raiderId)} className="p-1 text-red-400 hover:bg-red-500/20 rounded">
                                    <Icons.X />
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                          
                          {nonParticipants(raid).length > 0 && (
                            <div>
                              <p className="text-xs text-slate-500 mb-2">Add participant:</p>
                              <div className="flex flex-wrap gap-2">
                                {nonParticipants(raid).map(r => (
                                  <button key={r.id} onClick={() => addParticipant(r.id)} className="px-3 py-1 bg-slate-700/50 hover:bg-slate-700 text-slate-400 hover:text-slate-200 rounded text-sm">
                                    + {r.name}
                                  </button>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>

                        {/* Edit Bosses */}
                        <div>
                          <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Edit Bosses Killed</h4>
                          <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                            {bosses.map(b => (
                              <div key={b} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg">
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input type="checkbox" checked={editBosses.includes(b)} onChange={() => toggleBoss(b)} className="w-4 h-4 rounded" />
                                  <span className="text-slate-300 text-sm">{b}</span>
                                </label>
                                {editBosses.includes(b) && (
                                  <label className="flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" checked={editProgBosses.includes(b)} onChange={() => toggleProgBoss(b)} className="w-3 h-3 rounded" />
                                    <span className="text-amber-400 text-xs">Prog</span>
                                  </label>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Save/Cancel Buttons */}
                        <div className="flex gap-3 pt-4 border-t border-slate-700/50">
                          <button onClick={cancelEditing} className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg">Cancel</button>
                          <button onClick={() => saveEdits(raid)} className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg flex items-center justify-center gap-2">
                            <Icons.Save /> Save Changes
                          </button>
                        </div>
                      </div>
                    ) : (
                      <>
                        {/* Normal View - Participants */}
                        <div>
                          <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Participants & DKP Earned</h4>
                          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            {raid.participants.map(p => (
                              <div key={p.raiderId} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg">
                                <span className="text-slate-300 text-sm">{getName(p.raiderId)}</span>
                                <span className="text-amber-400 font-semibold">+{p.dkpEarned}</span>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Normal View - Bosses */}
                        {raid.bossesKilled?.length > 0 && (
                          <div>
                            <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Bosses Killed ({raid.bossesKilled.length})</h4>
                            <div className="flex flex-wrap gap-2">
                              {raid.bossesKilled.map((b, i) => (
                                <span key={i} className={`px-3 py-1 rounded-full text-sm ${raid.progBosses?.includes(b) ? 'bg-amber-500/20 text-amber-400' : 'bg-green-500/20 text-green-400'}`}>
                                  {b} {raid.progBosses?.includes(b) && '(Prog)'}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}

                        {/* Normal View - Loot */}
                        {loot.length > 0 && (
                          <div>
                            <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Loot Distributed ({loot.length})</h4>
                            <div className="space-y-2">
                              {loot.map(l => (
                                <div key={l.id} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg">
                                  <div><span className="text-slate-100 font-medium">{l.itemName}</span><span className="text-slate-500 text-sm ml-2"> {getName(l.winnerId)}</span></div>
                                  <span className="text-red-400 font-semibold">-{l.dkpCost} DKP</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </>
                    )}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
};

// ============================================================================
// EDIT ICON (add to Icons object)
// ============================================================================

Icons.Edit = () => (
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
  </svg>
);

// ============================================================================
// LOOT TAB
// ============================================================================

const LootTab = ({ lootHistory, raiders, isAdmin, onRecord }) => {
  const [showModal, setShowModal] = useState(false);
  const [filter, setFilter] = useState('all');
  
  // Loot recording state
  const [selectedRaidType, setSelectedRaidType] = useState('');
  const [selectedItem, setSelectedItem] = useState(null);
  const [customItemName, setCustomItemName] = useState('');
  const [winnerId, setWinnerId] = useState('');
  const [category, setCategory] = useState('weapons');
  const [isBis, setIsBis] = useState(true);
  const [itemSearch, setItemSearch] = useState('');

  // Load Wowhead tooltips
  useEffect(() => {
    if (!document.getElementById('wowhead-script')) {
      const whTooltips = document.createElement('script');
      whTooltips.id = 'wowhead-script';
      whTooltips.src = 'https://wow.zamimg.com/js/tooltips.js';
      document.head.appendChild(whTooltips);
      window.whTooltips = { colorLinks: true, iconizeLinks: true, renameLinks: true };
    }
    if (showModal && window.$WowheadPower) {
      setTimeout(() => window.$WowheadPower.refreshLinks(), 100);
    }
  }, [showModal, selectedRaidType, selectedItem]);

  const getName = (id) => raiders.find(r => r.id === id)?.name || 'Unknown';
  const getClass = (id) => raiders.find(r => r.id === id)?.class || null;
  const filteredLoot = useMemo(() => filter === 'all' ? lootHistory : lootHistory.filter(l => l.winnerId === filter), [lootHistory, filter]);

  const selectedRaider = raiders.find(r => r.id === winnerId);
  const cost = selectedRaider ? calcCost(selectedRaider.dkp, category, isBis) : 0;

  const raidLoot = useMemo(() => {
    if (!selectedRaidType || !RAID_LOOT[selectedRaidType]) return [];
    const loot = RAID_LOOT[selectedRaidType];
    if (!itemSearch) return loot;
    return loot.filter(item => item.name.toLowerCase().includes(itemSearch.toLowerCase()));
  }, [selectedRaidType, itemSearch]);

  const handleSelectItem = (item) => {
    setSelectedItem(item);
    setCategory(item.cat);
    setCustomItemName('');
    setTimeout(() => window.$WowheadPower?.refreshLinks(), 50);
  };

  const resetItemSelection = () => {
    setSelectedItem(null);
    setCustomItemName('');
    setItemSearch('');
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    const itemName = selectedItem ? selectedItem.name : customItemName;
    if (!itemName || !winnerId) return;
    onRecord({ 
      itemName, 
      winnerId, 
      category, 
      isBis, 
      dkpCost: cost, 
      raidId: null,
      wowheadId: selectedItem?.id || null
    });
    setShowModal(false);
    setSelectedRaidType('');
    setSelectedItem(null);
    setCustomItemName('');
    setWinnerId('');
    setItemSearch('');
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold text-amber-400">Loot Log</h2>
          <p className="text-slate-400 text-sm mt-1">{lootHistory.length} items distributed</p>
        </div>
        <div className="flex gap-3">
          <select value={filter} onChange={e => setFilter(e.target.value)} className="px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50 text-sm">
            <option value="all">All Raiders</option>
            {raiders.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
          </select>
          {isAdmin && (
            <button onClick={() => setShowModal(true)} className="flex items-center gap-2 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg">
              <Icons.Plus /> Record Loot
            </button>
          )}
        </div>
      </div>

      {filteredLoot.length === 0 ? (
        <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-12 text-center text-slate-500">No loot recorded yet</div>
      ) : (
        <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="bg-slate-900/50 border-b border-slate-700/50">
                  <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Item</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Winner</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Category</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Type</th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Cost</th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-slate-400 uppercase">Date</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-700/30">
                {filteredLoot.map(l => (
                  <tr key={l.id} className="hover:bg-slate-700/20 transition-colors">
                    <td className="px-4 py-3">
                      {l.wowheadId ? (
                        <a href={`https://tbc.wowhead.com/item=${l.wowheadId}`} target="_blank" rel="noopener noreferrer" data-wowhead={`item=${l.wowheadId}&domain=tbc`} className="font-semibold">{l.itemName}</a>
                      ) : (
                        <span className="font-semibold text-slate-100">{l.itemName}</span>
                      )}
                    </td>
                    <td className="px-4 py-3"><span className="font-medium" style={{ color: getClassColor(getClass(l.winnerId)) }}>{getName(l.winnerId)}</span></td>
                    <td className="px-4 py-3 text-slate-400 text-sm">{ITEM_CATS[l.category]?.label || l.category}</td>
                    <td className="px-4 py-3"><span className={`px-2 py-1 rounded text-xs font-medium ${l.isBis ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-600/50 text-slate-400'}`}>{l.isBis ? 'BiS' : 'Non-BiS'}</span></td>
                    <td className="px-4 py-3 text-right text-red-400 font-semibold">-{l.dkpCost}</td>
                    <td className="px-4 py-3 text-right text-slate-500 text-sm">{fmtDate(l.timestamp)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {showModal && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold text-amber-400">Record Loot</h2>
              <button onClick={() => { setShowModal(false); resetItemSelection(); setSelectedRaidType(''); setWinnerId(''); }} className="text-slate-400 hover:text-slate-200 p-1"><Icons.X /></button>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              {/* Step 1: Select Raid */}
              <div>
                <label className="block text-sm font-medium text-amber-400 mb-2">Step 1: Select Raid</label>
                <select 
                  value={selectedRaidType} 
                  onChange={e => { setSelectedRaidType(e.target.value); resetItemSelection(); }} 
                  className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50"
                >
                  <option value="">Choose a raid...</option>
                  {Object.entries(TBC_RAIDS).map(([k, v]) => <option key={k} value={k}>{v.name}</option>)}
                </select>
              </div>

              {/* Step 2: Select Item */}
              {selectedRaidType && (
                <div>
                  <label className="block text-sm font-medium text-amber-400 mb-2">Step 2: Select Item</label>
                  
                  <input
                    type="text"
                    value={itemSearch}
                    onChange={e => setItemSearch(e.target.value)}
                    placeholder="Search items..."
                    className="w-full px-4 py-2 mb-3 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 placeholder-slate-500 focus:outline-none focus:border-amber-500/50"
                  />

                  {selectedItem && (
                    <div className="mb-3 p-3 bg-slate-900/80 border border-amber-500/50 rounded-lg flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <a href={`https://tbc.wowhead.com/item=${selectedItem.id}`} data-wowhead={`item=${selectedItem.id}&domain=tbc`} target="_blank" rel="noopener noreferrer" className="font-semibold text-lg">{selectedItem.name}</a>
                        <span className="text-xs px-2 py-1 bg-slate-700 rounded text-slate-400">{ITEM_CATS[selectedItem.cat]?.label}</span>
                      </div>
                      <button type="button" onClick={resetItemSelection} className="text-slate-400 hover:text-red-400"><Icons.X /></button>
                    </div>
                  )}

                  {!selectedItem && (
                    <div className="max-h-64 overflow-y-auto bg-slate-900/50 rounded-lg border border-slate-700/50 p-2">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        {raidLoot.map(item => (
                          <button
                            key={`${item.id}-${item.name}`}
                            type="button"
                            onClick={() => handleSelectItem(item)}
                            className="flex items-center gap-2 p-2 text-left rounded-lg hover:bg-slate-700/50 transition-colors border border-transparent hover:border-amber-500/30"
                          >
                            <a href={`https://tbc.wowhead.com/item=${item.id}`} data-wowhead={`item=${item.id}&domain=tbc`} onClick={e => e.preventDefault()} className="text-sm truncate flex-1">{item.name}</a>
                          </button>
                        ))}
                      </div>
                      {raidLoot.length === 0 && <p className="text-center text-slate-500 py-4">No items found</p>}
                    </div>
                  )}

                  <div className="mt-3 pt-3 border-t border-slate-700/50">
                    <label className="block text-xs text-slate-500 mb-2">Or enter custom item name:</label>
                    <input
                      type="text"
                      value={customItemName}
                      onChange={e => { setCustomItemName(e.target.value); setSelectedItem(null); }}
                      placeholder="Custom item name..."
                      className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 placeholder-slate-500 focus:outline-none focus:border-amber-500/50"
                    />
                  </div>
                </div>
              )}

              {/* Step 3: Winner & Details */}
              {(selectedItem || customItemName) && (
                <>
                  <div>
                    <label className="block text-sm font-medium text-amber-400 mb-2">Step 3: Select Winner</label>
                    <select value={winnerId} onChange={e => setWinnerId(e.target.value)} required className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50">
                      <option value="">Select raider...</option>
                      {raiders.map(r => <option key={r.id} value={r.id}>{r.name} ({r.dkp} DKP)</option>)}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-amber-400 mb-2">Step 4: Category & Type</label>
                    <select value={category} onChange={e => setCategory(e.target.value)} className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50 mb-3">
                      {Object.entries(ITEM_CATS).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
                    </select>
                    <div className="flex items-center gap-4">
                      <label className="flex items-center gap-2 cursor-pointer"><input type="radio" checked={isBis} onChange={() => setIsBis(true)} className="w-4 h-4" /><span className="text-slate-300">BiS / Main Spec</span></label>
                      <label className="flex items-center gap-2 cursor-pointer"><input type="radio" checked={!isBis} onChange={() => setIsBis(false)} className="w-4 h-4" /><span className="text-slate-300">Non-BiS / Off Spec</span></label>
                    </div>
                  </div>

                  {selectedRaider && (
                    <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700/50 space-y-2">
                      <div className="flex justify-between"><span className="text-slate-400">Current DKP:</span><span className="text-slate-100 font-semibold">{selectedRaider.dkp}</span></div>
                      <div className="flex justify-between"><span className="text-slate-400">Cost ({isBis ? ITEM_CATS[category]?.bis : ITEM_CATS[category]?.nonBis}%):</span><span className="text-red-400 font-semibold">-{cost}</span></div>
                      <div className="flex justify-between pt-2 border-t border-slate-700/50"><span className="text-slate-400">After:</span><span className="text-amber-400 font-semibold">{selectedRaider.dkp - cost}</span></div>
                    </div>
                  )}
                </>
              )}

              <div className="flex gap-3 pt-2">
                <button type="button" onClick={() => { setShowModal(false); resetItemSelection(); setSelectedRaidType(''); setWinnerId(''); }} className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg">Cancel</button>
                <button type="submit" disabled={!(selectedItem || customItemName) || !winnerId} className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-slate-900 font-semibold rounded-lg">Record Loot</button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

// ============================================================================
// ADMIN TAB
// ============================================================================

const AdminTab = ({ raiders, raidHistory, onAdd, onRemove, onUpdateDKP, onSetDKP, onDecay, onComplete, onRecordLoot }) => {
  const [subTab, setSubTab] = useState('raiders');
  const [newName, setNewName] = useState('');
  const [newClass, setNewClass] = useState('Warrior');
  const [newRank, setNewRank] = useState('Trial');

  // Run Raid State
  const [selectedRaid, setSelectedRaid] = useState('karazhan');
  const [selectedRaiders, setSelectedRaiders] = useState([]);
  const [bossesKilled, setBossesKilled] = useState([]);
  const [progBosses, setProgBosses] = useState([]);
  const [raiderBonuses, setRaiderBonuses] = useState({});
  const [lootItems, setLootItems] = useState([]);
  const [showLootModal, setShowLootModal] = useState(false);
  const [lootItem, setLootItem] = useState('');
  const [lootWinner, setLootWinner] = useState('');
  const [lootCat, setLootCat] = useState('weapons');
  const [lootBis, setLootBis] = useState(true);

  // DKP Adjustment State
  const [bulkAmount, setBulkAmount] = useState(0);
  const [manualId, setManualId] = useState('');
  const [manualAmount, setManualAmount] = useState(0);

  const handleAddRaider = (e) => {
    if (e) e.preventDefault();
    if (!newName.trim()) return;
    onAdd(newName.trim(), newClass, newRank);
    setNewName('');
  };

  const toggleRaider = (id) => {
    setSelectedRaiders(p => p.includes(id) ? p.filter(r => r !== id) : [...p, id]);
    if (!raiderBonuses[id]) setRaiderBonuses(p => ({ ...p, [id]: { onTime: false, consumesFull: false, consumesPartial: false, avgParse60: false, bench: false } }));
  };

  const toggleBonus = (id, key) => {
    setRaiderBonuses(p => ({
      ...p, [id]: {
        ...p[id], [key]: !p[id]?.[key],
        ...(key === 'consumesFull' && !p[id]?.consumesFull ? { consumesPartial: false } : {}),
        ...(key === 'consumesPartial' && !p[id]?.consumesPartial ? { consumesFull: false } : {})
      }
    }));
  };

  const applyToAll = (key) => {
    setRaiderBonuses(p => {
      const u = { ...p };
      selectedRaiders.forEach(id => { u[id] = { ...u[id], [key]: true, ...(key === 'consumesFull' ? { consumesPartial: false } : {}), ...(key === 'consumesPartial' ? { consumesFull: false } : {}) }; });
      return u;
    });
  };

  const toggleBoss = (b) => { setBossesKilled(p => p.includes(b) ? p.filter(x => x !== b) : [...p, b]); if (bossesKilled.includes(b)) setProgBosses(p => p.filter(x => x !== b)); };
  const toggleProg = (b) => setProgBosses(p => p.includes(b) ? p.filter(x => x !== b) : [...p, b]);

  const calcDKP = (id) => {
    const b = raiderBonuses[id] || {};
    let t = 0;
    if (b.onTime) t += DKP_CATEGORIES.onTime.dkp;
    if (b.consumesFull) t += DKP_CATEGORIES.consumesFull.dkp;
    if (b.consumesPartial) t += DKP_CATEGORIES.consumesPartial.dkp;
    if (b.avgParse60) t += DKP_CATEGORIES.avgParse60.dkp;
    if (b.bench) { t += DKP_CATEGORIES.bench.dkp; }
    else { t += bossesKilled.length * DKP_CATEGORIES.bossKill.dkp + progBosses.length * DKP_CATEGORIES.progBossKill.dkp; }
    return t;
  };

  const handleComplete = () => {
    if (selectedRaiders.length === 0) { alert('Select at least one raider'); return; }
    const raidId = genId();
    const participants = selectedRaiders.map(id => ({ raiderId: id, dkpEarned: calcDKP(id), bonuses: raiderBonuses[id] || {} }));
    onComplete({ raidType: selectedRaid, participants, bossesKilled, progBosses, lootDistributed: lootItems });
    lootItems.forEach(item => onRecordLoot({ ...item, raidId }));
    setSelectedRaiders([]); setBossesKilled([]); setProgBosses([]); setRaiderBonuses({}); setLootItems([]);
    alert('Raid completed! DKP awarded.');
  };

  const addLoot = (e) => {
    e.preventDefault();
    if (!lootItem || !lootWinner) return;
    const winner = raiders.find(r => r.id === lootWinner);
    const cost = winner ? calcCost(winner.dkp, lootCat, lootBis) : 0;
    setLootItems(p => [...p, { id: genId(), itemName: lootItem, winnerId: lootWinner, category: lootCat, isBis: lootBis, dkpCost: cost }]);
    setShowLootModal(false); setLootItem(''); setLootWinner('');
  };

  const bosses = TBC_RAIDS[selectedRaid]?.bosses || [];
  const getName = (id) => raiders.find(r => r.id === id)?.name || 'Unknown';

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold text-amber-400">Admin Panel</h2>
        <p className="text-slate-400 text-sm mt-1">Manage raiders, raids, and DKP</p>
      </div>

      <div className="flex gap-2 border-b border-slate-700/50 pb-2">
        {[{ id: 'raiders', label: 'Manage Raiders' }, { id: 'runraid', label: 'Run Raid' }, { id: 'dkp', label: 'DKP Adjustments' }].map(t => (
          <button key={t.id} onClick={() => setSubTab(t.id)} className={`px-4 py-2 text-sm font-medium rounded-lg ${subTab === t.id ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50'}`}>{t.label}</button>
        ))}
      </div>

      {/* MANAGE RAIDERS */}
      {subTab === 'raiders' && (
        <div className="space-y-6">
          <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
            <h3 className="text-lg font-semibold text-amber-400 mb-4">Add New Raider</h3>
            <form onSubmit={handleAddRaider} className="flex flex-wrap gap-4">
              <input type="text" value={newName} onChange={e => setNewName(e.target.value)} placeholder="Character name" className="flex-1 min-w-[200px] px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 placeholder-slate-500 focus:outline-none focus:border-amber-500/50" />
              <select value={newClass} onChange={e => setNewClass(e.target.value)} className="px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50">
                {WOW_CLASSES.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}
              </select>
              <select value={newRank} onChange={e => setNewRank(e.target.value)} className="px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50">
                <option value="Trial">Trial</option><option value="Raider">Raider</option><option value="Officer">Officer</option>
              </select>
              <button type="submit" onClick={handleAddRaider} className="flex items-center gap-2 px-6 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg"><Icons.Plus /> Add</button>
            </form>
          </div>

          <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
            <h3 className="text-lg font-semibold text-amber-400 mb-4">Current Roster ({raiders.length})</h3>
            {raiders.length === 0 ? <p className="text-slate-500 text-center py-8">No raiders</p> : (
              <div className="grid gap-3">
                {raiders.map(r => (
                  <div key={r.id} className="flex items-center justify-between p-4 bg-slate-900/50 rounded-lg border border-slate-700/30">
                    <div className="flex items-center gap-4">
                      <span className="font-semibold text-slate-100">{r.name}</span>
                      <span className="px-2 py-0.5 rounded text-sm" style={{ color: getClassColor(r.class), backgroundColor: `${getClassColor(r.class)}20` }}>{r.class}</span>
                      <span className={`px-2 py-0.5 rounded text-xs ${r.rank === 'Trial' ? 'bg-yellow-500/20 text-yellow-400' : r.rank === 'Officer' ? 'bg-purple-500/20 text-purple-400' : 'bg-green-500/20 text-green-400'}`}>{r.rank}</span>
                    </div>
                    <div className="flex items-center gap-4">
                      <span className="text-amber-400 font-semibold">{r.dkp} DKP</span>
                      <button onClick={() => onRemove(r.id)} className="p-2 text-red-400 hover:bg-red-500/20 rounded-lg"><Icons.Trash /></button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* RUN RAID */}
      {subTab === 'runraid' && (
        <div className="space-y-6">
          <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
            <h3 className="text-lg font-semibold text-amber-400 mb-4">Select Raid</h3>
            <select value={selectedRaid} onChange={e => { setSelectedRaid(e.target.value); setBossesKilled([]); setProgBosses([]); }} className="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50">
              {Object.entries(TBC_RAIDS).map(([k, v]) => <option key={k} value={k}>{v.name}</option>)}
            </select>
          </div>

          <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-amber-400">Select Roster ({selectedRaiders.length})</h3>
              <div className="flex gap-2">
                <button onClick={() => setSelectedRaiders(raiders.map(r => r.id))} className="px-3 py-1 text-sm bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-300">Select All</button>
                <button onClick={() => { setSelectedRaiders([]); setRaiderBonuses({}); }} className="px-3 py-1 text-sm bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-300">Clear</button>
              </div>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
              {raiders.map(r => (
                <button key={r.id} onClick={() => toggleRaider(r.id)} className={`p-3 rounded-lg text-left transition-colors ${selectedRaiders.includes(r.id) ? 'bg-amber-500/20 border border-amber-500/50' : 'bg-slate-900/50 border border-slate-700/30 hover:border-slate-600'}`}>
                  <span className="font-medium" style={{ color: getClassColor(r.class) }}>{r.name}</span>
                </button>
              ))}
            </div>
          </div>

          <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
            <h3 className="text-lg font-semibold text-amber-400 mb-4">Bosses Killed</h3>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
              {bosses.map(b => (
                <div key={b} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" checked={bossesKilled.includes(b)} onChange={() => toggleBoss(b)} className="w-4 h-4 rounded" />
                    <span className="text-slate-300 text-sm">{b}</span>
                  </label>
                  {bossesKilled.includes(b) && (
                    <label className="flex items-center gap-1 cursor-pointer">
                      <input type="checkbox" checked={progBosses.includes(b)} onChange={() => toggleProg(b)} className="w-3 h-3 rounded" />
                      <span className="text-amber-400 text-xs">Prog</span>
                    </label>
                  )}
                </div>
              ))}
            </div>
          </div>

          {selectedRaiders.length > 0 && (
            <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-amber-400">Raider Bonuses</h3>
                <div className="flex flex-wrap gap-2">
                  {Object.entries(DKP_CATEGORIES).filter(([k]) => !['bossKill', 'progBossKill'].includes(k)).map(([k, v]) => (
                    <button key={k} onClick={() => applyToAll(k)} className="px-2 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded text-slate-300">All {v.label}</button>
                  ))}
                </div>
              </div>
              <div className="space-y-3 max-h-96 overflow-y-auto">
                {selectedRaiders.map(id => {
                  const r = raiders.find(x => x.id === id);
                  const b = raiderBonuses[id] || {};
                  return (
                    <div key={id} className="p-4 bg-slate-900/50 rounded-lg">
                      <div className="flex items-center justify-between mb-3">
                        <span className="font-semibold" style={{ color: getClassColor(r?.class) }}>{r?.name}</span>
                        <span className="text-amber-400 font-bold">+{calcDKP(id)} DKP</span>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {Object.entries(DKP_CATEGORIES).filter(([k]) => !['bossKill', 'progBossKill'].includes(k)).map(([k, v]) => (
                          <button key={k} onClick={() => toggleBonus(id, k)} className={`px-3 py-1 text-xs rounded-full transition-colors ${b[k] ? 'bg-green-500/30 text-green-400 border border-green-500/50' : 'bg-slate-700/50 text-slate-400 border border-slate-600'}`}>
                            {v.label} (+{v.dkp})
                          </button>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-amber-400">Loot Distribution ({lootItems.length})</h3>
              <button onClick={() => setShowLootModal(true)} className="flex items-center gap-2 px-4 py-2 bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 rounded-lg border border-amber-500/30"><Icons.Plus /> Add Item</button>
            </div>
            {lootItems.length === 0 ? <p className="text-slate-500 text-center py-4">No loot added yet</p> : (
              <div className="space-y-2">
                {lootItems.map(l => (
                  <div key={l.id} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg">
                    <div><span className="text-slate-100 font-medium">{l.itemName}</span><span className="text-slate-500 text-sm ml-2"> {getName(l.winnerId)}</span></div>
                    <div className="flex items-center gap-3">
                      <span className="text-red-400 font-semibold">-{l.dkpCost}</span>
                      <button onClick={() => setLootItems(p => p.filter(x => x.id !== l.id))} className="p-1 text-red-400 hover:bg-red-500/20 rounded"><Icons.X /></button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          <button onClick={handleComplete} className="w-full py-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold text-lg rounded-xl transition-colors flex items-center justify-center gap-2">
            <Icons.Save /> Complete Raid & Award DKP
          </button>

          {showLootModal && (
            <Modal title="Add Loot Item" onClose={() => setShowLootModal(false)}>
              <form onSubmit={addLoot} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-400 mb-2">Item Name</label>
                  <input type="text" value={lootItem} onChange={e => setLootItem(e.target.value)} placeholder="Item name" required className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-400 mb-2">Winner</label>
                  <select value={lootWinner} onChange={e => setLootWinner(e.target.value)} required className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50">
                    <option value="">Select...</option>
                    {selectedRaiders.map(id => { const r = raiders.find(x => x.id === id); return <option key={id} value={id}>{r?.name} ({r?.dkp} DKP)</option>; })}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-400 mb-2">Category</label>
                  <select value={lootCat} onChange={e => setLootCat(e.target.value)} className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50">
                    {Object.entries(ITEM_CATS).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
                  </select>
                </div>
                <div className="flex items-center gap-4">
                  <label className="flex items-center gap-2 cursor-pointer"><input type="radio" checked={lootBis} onChange={() => setLootBis(true)} className="w-4 h-4" /><span className="text-slate-300">BiS/MS</span></label>
                  <label className="flex items-center gap-2 cursor-pointer"><input type="radio" checked={!lootBis} onChange={() => setLootBis(false)} className="w-4 h-4" /><span className="text-slate-300">Non-BiS/OS</span></label>
                </div>
                <div className="flex gap-3 pt-2">
                  <button type="button" onClick={() => setShowLootModal(false)} className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg">Cancel</button>
                  <button type="submit" className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg">Add</button>
                </div>
              </form>
            </Modal>
          )}
        </div>
      )}

      {/* DKP ADJUSTMENTS */}
      {subTab === 'dkp' && (
        <div className="space-y-6">
          <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
            <h3 className="text-lg font-semibold text-amber-400 mb-4">Bulk DKP Adjustment</h3>
            <div className="flex flex-wrap gap-4 items-end">
              <div className="flex-1 min-w-[200px]">
                <label className="block text-sm font-medium text-slate-400 mb-2">Amount</label>
                <input type="number" value={bulkAmount} onChange={e => setBulkAmount(parseInt(e.target.value) || 0)} className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50" />
              </div>
              <button onClick={() => { raiders.forEach(r => onUpdateDKP(r.id, bulkAmount)); setBulkAmount(0); }} className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg">Add to All</button>
              <button onClick={() => { raiders.forEach(r => onUpdateDKP(r.id, -bulkAmount)); setBulkAmount(0); }} className="px-6 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg">Remove from All</button>
            </div>
          </div>

          <div className="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
            <h3 className="text-lg font-semibold text-amber-400 mb-4">Individual DKP Adjustment</h3>
            <div className="flex flex-wrap gap-4 items-end">
              <div className="flex-1 min-w-[200px]">
                <label className="block text-sm font-medium text-slate-400 mb-2">Raider</label>
                <select value={manualId} onChange={e => setManualId(e.target.value)} className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50">
                  <option value="">Select...</option>
                  {raiders.map(r => <option key={r.id} value={r.id}>{r.name} ({r.dkp} DKP)</option>)}
                </select>
              </div>
              <div className="w-32">
                <label className="block text-sm font-medium text-slate-400 mb-2">Amount</label>
                <input type="number" value={manualAmount} onChange={e => setManualAmount(parseInt(e.target.value) || 0)} className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 focus:outline-none focus:border-amber-500/50" />
              </div>
              <button onClick={() => { if (manualId) { onSetDKP(manualId, manualAmount); setManualAmount(0); } }} className="px-6 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg">Set DKP</button>
            </div>
          </div>

          <div className="bg-red-900/20 border border-red-500/30 rounded-xl p-6">
            <h3 className="text-lg font-semibold text-red-400 mb-4">Apply 50% Decay</h3>
            <p className="text-slate-400 mb-4">This will reduce all raiders' DKP by 50%. This should be done every 4 raids.</p>
            <p className="text-slate-500 text-sm mb-4">Completed raids: {raidHistory.length} (Decay recommended at raids 4, 8, 12, etc.)</p>
            <button onClick={() => { if (confirm('Apply 50% decay to all raiders?')) onDecay(); }} className="px-6 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg">Apply Decay</button>
          </div>
        </div>
      )}
    </div>
  );
};

// ============================================================================
// MAIN APP
// ============================================================================

export default function DKPTracker() {
  
// UI state
const [tab, setTab] = useState('standings');

// Admin login (Supabase Auth)
const [isAdmin, setIsAdmin] = useState(false);
const [showLogin, setShowLogin] = useState(false);
const [loginErr, setLoginErr] = useState("");

const [email, setEmail] = useState("");
const [authPassword, setAuthPassword] = useState("");

const [session, setSession] = useState(null);
const [authLoading, setAuthLoading] = useState(true);

  // Supabase DB state
  const [db, setDb, loading, error] = useSupabaseState();

 useEffect(() => {
  // initial session load
  supabase.auth.getSession().then(({ data }) => {
    setSession(data.session ?? null);
    setAuthLoading(false);
    setIsAdmin(!!data.session);
  });

  // listen for login/logout changes
  const { data: sub } = supabase.auth.onAuthStateChange((_event, newSession) => {
    setSession(newSession ?? null);
    setAuthLoading(false);
    setIsAdmin(!!newSession);
  });

  return () => {
    sub?.subscription?.unsubscribe?.();
  };
}, []);

  // Use safe defaults until Supabase loads
  const raiders = db?.raiders ?? [];
  const raidHistory = db?.raidHistory ?? [];
  const scheduled = db?.scheduled ?? [];
  const lootHistory = db?.lootHistory ?? [];

  // Setter wrappers: keep the rest of your code unchanged
  const setRaiders = (updater) => {
    const next = typeof updater === "function" ? updater(raiders) : updater;
    setDb((prev) => ({ ...(prev ?? {}), raiders: next }));
  };

  const setRaidHistory = (updater) => {
    const next = typeof updater === "function" ? updater(raidHistory) : updater;
    setDb((prev) => ({ ...(prev ?? {}), raidHistory: next }));
  };

  const setScheduled = (updater) => {
    const next = typeof updater === "function" ? updater(scheduled) : updater;
    setDb((prev) => ({ ...(prev ?? {}), scheduled: next }));
  };

  const setLootHistory = (updater) => {
    const next = typeof updater === "function" ? updater(lootHistory) : updater;
    setDb((prev) => ({ ...(prev ?? {}), lootHistory: next }));
  };




  const addRaider = (name, cls, rank) => setRaiders(p => [...p, { id: genId(), name, class: cls, rank, dkp: 0, raidCount: 0, createdAt: new Date().toISOString() }]);
  const removeRaider = (id) => setRaiders(p => p.filter(r => r.id !== id));
  const updateDKP = (id, amt) => setRaiders(p => p.map(r => r.id === id ? { ...r, dkp: Math.max(0, r.dkp + amt) } : r));
  const setDKP = (id, amt) => setRaiders(p => p.map(r => r.id === id ? { ...r, dkp: Math.max(0, amt) } : r));
  const promoteRaider = (id) => {
    const avg = raiders.filter(r => r.rank === 'Raider').reduce((s, r) => s + r.dkp, 0) / Math.max(1, raiders.filter(r => r.rank === 'Raider').length);
    setRaiders(p => p.map(r => r.id === id ? { ...r, rank: 'Raider', dkp: r.dkp + Math.floor(avg * 0.6) } : r));
  };
  const applyDecay = () => setRaiders(p => p.map(r => ({ ...r, dkp: Math.floor(r.dkp * 0.5) })));

  const scheduleRaid = (data) => setScheduled(p => [...p, { id: genId(), ...data, createdAt: new Date().toISOString() }]);
  const removeScheduled = (id) => setScheduled(p => p.filter(r => r.id !== id));
  const updateScheduledRaid = (id, updates) => setScheduled(p => p.map(r => r.id === id ? { ...r, ...updates } : r));

  const completeRaid = (data) => {
    const raid = { id: genId(), ...data, completedAt: new Date().toISOString() };
    setRaidHistory(p => [raid, ...p]);
    
    // Update all raiders in a single state update to avoid race conditions
    setRaiders(prevRaiders => {
      return prevRaiders.map(r => {
        const participant = data.participants.find(pt => pt.raiderId === r.id);
        if (participant) {
          return { ...r, dkp: r.dkp + participant.dkpEarned, raidCount: r.raidCount + 1 };
        }
        return r;
      });
    });
  };

  const recordLoot = (data) => {
    setLootHistory(p => [{ id: genId(), ...data, timestamp: new Date().toISOString() }, ...p]);
    setRaiders(p => p.map(r => r.id === data.winnerId ? { ...r, dkp: Math.max(0, r.dkp - data.dkpCost) } : r));
  };

  const editRaid = (raidId, updates, editEntry) => {
    // Get the original raid to calculate DKP differences
    const originalRaid = raidHistory.find(r => r.id === raidId);
    if (!originalRaid) return;

    // Calculate DKP adjustments needed
    const dkpAdjustments = {};

    // Handle removed participants (subtract their original DKP)
    originalRaid.participants.forEach(origP => {
      const stillExists = updates.participants.find(p => p.raiderId === origP.raiderId);
      if (!stillExists) {
        dkpAdjustments[origP.raiderId] = (dkpAdjustments[origP.raiderId] || 0) - origP.dkpEarned;
      }
    });

    // Handle added participants and DKP changes
    updates.participants.forEach(newP => {
      const origP = originalRaid.participants.find(p => p.raiderId === newP.raiderId);
      if (!origP) {
        // New participant - add their DKP
        dkpAdjustments[newP.raiderId] = (dkpAdjustments[newP.raiderId] || 0) + newP.dkpEarned;
      } else if (origP.dkpEarned !== newP.dkpEarned) {
        // Existing participant with changed DKP - adjust the difference
        dkpAdjustments[newP.raiderId] = (dkpAdjustments[newP.raiderId] || 0) + (newP.dkpEarned - origP.dkpEarned);
      }
    });

    // Apply DKP adjustments to raiders
    if (Object.keys(dkpAdjustments).length > 0) {
      setRaiders(prevRaiders => {
        return prevRaiders.map(r => {
          if (dkpAdjustments[r.id]) {
            return { ...r, dkp: Math.max(0, r.dkp + dkpAdjustments[r.id]) };
          }
          return r;
        });
      });
    }

    // Update the raid history with edits and changelog
    setRaidHistory(prev => prev.map(raid => {
      if (raid.id === raidId) {
        return {
          ...raid,
          ...updates,
          editHistory: [...(raid.editHistory || []), editEntry]
        };
      }
      return raid;
    }));
  };

  const nextRaid = useMemo(() => {
    const now = new Date();
    const upcoming = scheduled.filter(r => new Date(r.dateTime) > now).sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
    return upcoming[0] || null;
  }, [scheduled]);

  const tabs = [
    { id: 'standings', label: 'DKP Standings', icon: <Icons.Users /> },
    { id: 'raids', label: 'Raid Schedule', icon: <Icons.Calendar /> },
    { id: 'history', label: 'Raid History', icon: <Icons.History /> },
    { id: 'loot', label: 'Loot Log', icon: <Icons.Sword /> },
    ...(isAdmin ? [{ id: 'admin', label: 'Admin Panel', icon: <Icons.Settings /> }] : [])
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-100">
      {loading && (
  <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4">
    <div className="p-4 rounded-lg bg-slate-800 text-slate-200 mb-4 border border-slate-700">
      Loading DKP data...
    </div>
  </div>
)}
{error && (
  <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4">
    <div className="p-4 rounded-lg bg-red-900/30 text-red-200 mb-4 border border-red-700/40">
      Error loading DKP data: {String(error)}
    </div>
  </div>
)}
      <div className="fixed inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-0 left-1/4 w-96 h-96 bg-amber-500/5 rounded-full blur-3xl" />
        <div className="absolute bottom-0 right-1/4 w-96 h-96 bg-amber-600/5 rounded-full blur-3xl" />
      </div>

      <header className="relative border-b border-amber-500/20 bg-slate-900/80 backdrop-blur-sm sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            <div className="flex items-center gap-3">
              <div className="text-amber-500"><Icons.Anchor /></div>
              <div><h1 className="text-xl font-bold tracking-tight"><span className="text-amber-500">SUNKEN</span><span className="text-slate-400 font-normal ml-2">DKP System</span></h1></div>
            </div>
            {nextRaid && (
              <div className="hidden md:flex items-center gap-2 px-4 py-1.5 bg-amber-500/10 border border-amber-500/30 rounded-full">
                <Icons.Calendar />
                <span className="text-sm text-amber-200">Next: <span className="font-semibold">{TBC_RAIDS[nextRaid.raidType]?.name}</span><span className="text-amber-400/70 ml-2">{fmtDateTime(nextRaid.dateTime)}</span></span>
              </div>
            )}
          <div className="flex items-center gap-2">
  {isAdmin ? (
    <div className="flex items-center gap-3">
      <span className="text-xs px-2 py-1 bg-amber-500/20 text-amber-400 rounded-full border border-amber-500/30">
        Admin Mode
      </span>
      <button
        onClick={() => supabase.auth.signOut()}
        className="flex items-center gap-2 px-3 py-1.5 text-sm text-slate-400 hover:text-amber-400"
      >
        <Icons.Logout /> Logout
      </button>
    </div>
  ) : (
    <button
      onClick={() => setShowLogin(true)}
      className="flex items-center gap-2 px-4 py-1.5 text-sm bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 border border-amber-500/30 rounded-lg"
    >
      <Icons.Lock /> Admin Login
    </button>
  )}
</div>

          </div>
        </div>
      </header>

      <nav className="relative border-b border-slate-700/50 bg-slate-900/50 backdrop-blur-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex gap-1 overflow-x-auto py-2">
            {tabs.map(t => (
              <button key={t.id} onClick={() => setTab(t.id)} className={`flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg whitespace-nowrap transition-all ${tab === t.id ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50'}`}>
                {t.icon}{t.label}
              </button>
            ))}
          </div>
        </div>
      </nav>

      <main className="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {tab === 'standings' && <StandingsTab raiders={raiders} isAdmin={isAdmin} onUpdateDKP={updateDKP} onRemove={removeRaider} onPromote={promoteRaider} />}
        {tab === 'raids' && <RaidsTab scheduled={scheduled} raiders={raiders} isAdmin={isAdmin} onSchedule={scheduleRaid} onRemove={removeScheduled} onUpdateScheduled={updateScheduledRaid} />}
        {tab === 'history' && <HistoryTab raidHistory={raidHistory} lootHistory={lootHistory} raiders={raiders} isAdmin={isAdmin} onEditRaid={editRaid} />}
        {tab === 'loot' && <LootTab lootHistory={lootHistory} raiders={raiders} isAdmin={isAdmin} onRecord={recordLoot} />}
        {tab === 'admin' && isAdmin && (
  <AdminTab
    raiders={raiders}
    raidHistory={raidHistory}
    onAdd={addRaider}
    onRemove={removeRaider}
    onUpdateDKP={updateDKP}
    onSetDKP={setDKP}
    onDecay={applyDecay}
    onComplete={completeRaid}
    onRecordLoot={recordLoot}
  />
)}

      </main>

      <footer className="relative border-t border-slate-700/50 bg-slate-900/50 mt-auto">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div className="flex items-center justify-between text-sm text-slate-500">
            <span>Sunken Guild - TBC Classic</span>
            <span>DKP decays 50% every 4 raids</span>
          </div>
        </div>
      </footer>

      {showLogin && (
        <Modal title="Admin Login" onClose={() => { setShowLogin(false); setEmail(''); setAuthPassword(''); setLoginErr(''); }}>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-slate-400 mb-2">Email</label>
              <input type="email" value={email} onChange={e => setEmail(e.target.value)} autoFocus placeholder="Enter admin email" className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 placeholder-slate-500 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/50" />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-400 mb-2">Password</label>
              <input type="password" value={authPassword} onChange={e => setAuthPassword(e.target.value)} onKeyDown={e => { if (e.key === 'Enter') { setLoginErr(''); supabase.auth.signInWithPassword({ email, password: authPassword }).then(({ error }) => { if (error) setLoginErr(error.message); else { setShowLogin(false); setEmail(''); setAuthPassword(''); } }); }}} placeholder="Enter admin password" className="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-slate-100 placeholder-slate-500 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/50" />
              {loginErr && <p className="mt-2 text-sm text-red-400">{loginErr}</p>}
            </div>
            <button onClick={() => { setLoginErr(''); supabase.auth.signInWithPassword({ email, password: authPassword }).then(({ error }) => { if (error) setLoginErr(error.message); else { setShowLogin(false); setEmail(''); setAuthPassword(''); } }); }} className="w-full px-4 py-2 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold rounded-lg">Login</button>
          </div>
        </Modal>
      )}
    </div>
  );
}
